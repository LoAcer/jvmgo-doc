<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自己动手写Java虚拟机</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css" as="style"><link rel="preload" href="/jvmgo-doc/assets/js/app.0e038eb3.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/2.9a199717.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/9.76119271.js" as="script"><link rel="prefetch" href="/jvmgo-doc/assets/js/10.e6c9c852.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/11.c614ad39.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/12.f2736902.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/13.6ed656c8.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/14.abed2032.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/15.6c8db65d.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/16.1b00c595.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/17.14678ca3.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/18.a4cd171a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/19.bd53fbb2.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/20.28d8d8b4.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/3.6e9095c9.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/4.2e142e62.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/5.92e59ff4.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/6.9bd6201a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/7.ab861a63.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/8.12d8c35a.js">
    <link rel="stylesheet" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="第7章-方法调用和返回"><a href="#第7章-方法调用和返回" class="header-anchor">#</a> 第7章 方法调用和返回</h2> <p>第4章实现了Java虚拟机栈、帧等运行时数据区，为方法的执行打好了基础。第5章实现了一个简单的解释器和150多条指令，已经可以执行单个方法。第6章实现了方法区，为方法调用扫清了障碍。本章将实现方法调用和返回，在此基础上，还会讨论类和对象的初始化。</p> <p>开始本章之前，还是先把目录结构准备好。复制ch06目录，改名为ch07。修改main.go等文件，把import语句中的ch06全都替换成ch07。本章对目录结构没有太大的调整。</p> <h4 id="_7-1-方法调用概述"><a href="#_7-1-方法调用概述" class="header-anchor">#</a> 7.1 方法调用概述</h4> <p>从调用的角度来看，方法可以分为两类：静态方法（或者类方法）和实例方法。静态方法通过类来调用，实例方法则通过对象引用来调用。静态方法是静态绑定的，也就是说，最终调用的是哪个方法在编译期就已经确定。实例方法则支持动态绑定，最终要调用哪个方法可能要推迟到运行期才能知道，本章将详细讨论这一点。</p> <p>从实现的角度来看，方法可以分为三类：没有实现（也就是抽象方法）、用Java语言（或者JVM上的其他语言，如Groovy和Scala等）实现和用本地语言（如C或者C++）实现。静态方法和抽象方法是互斥的。在Java 8之前，接口只能包含抽象方法。为了实现Lambda表达式，Java 8放宽了这一限制，在接口中也可以定义静态方法和默认方法。本章不考虑接口的静态方法和默认方法，感兴趣的读者请阅读Java虚拟机规范相关章节。在本书中，我们把Java等语言实现的方法叫作Java方法。本章只讨论Java方法的调用，本地方法调用将在第9章中介绍。</p> <p>在Java 7之前，Java虚拟机规范一共提供了4条方法调用指令。其中invokestatic指令用来调用静态方法。invokespecial指令用来调用无须动态绑定的实例方法，包括构造函数、私有方法和通过super关键字调用的超类方法。剩下的情况则属于动态绑定。如果是针对接口类型的引用调用方法，就使用invokeinterface指令，否则使用invokevirtual指令。本章将实现这4条指令。</p> <p>为了更好地支持动态类型语言，Java 7增加了一条方法调用指令invokedynamic。本章不讨论这条指令，感兴趣的读者请阅读Java虚拟机规范相关章节。在深入讨论各条方法调用指令的细节之前，先简单了解Java虚拟机是如何调用方法的。</p> <p>首先，方法调用指令需要n+1个操作数，其中第1个操作数是uint16索引，在字节码中紧跟在指令操作码的后面。通过这个索引，可以从当前类的运行时常量池中找到一个方法符号引用，解析这个符号引用就可以得到一个方法。注意，这个方法并不一定就是最终要调用的那个方法，所以可能还需要一个查找过程才能找到最终要调用的方法。剩下的n个操作数是要传递给被调用方法的参数，从操作数栈中弹出。将在7.2小节讨论方法符号引用的解析。</p> <p>如果要执行的是Java方法（而非本地方法），下一步是给这个方法创建一个新的帧，并把它推到Java虚拟机栈顶。传递参数之后，新的方法就可以开始执行了。将在7.3小节讨论参数传递，本地方法调用则推迟到第9章再讨论。下面是一段伪代码，用于说明Java方法的调用过程。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>INVOKE_XXX<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    methodRef <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">.</span>MethodRef<span class="token punctuation">)</span> 
    resolved <span class="token operator">:=</span> <span class="token function">resolveMethodRef</span><span class="token punctuation">(</span>methodRef<span class="token punctuation">)</span> 
    <span class="token function">checkResolvedMethod</span><span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> 
    toBeInvoked <span class="token operator">:=</span> <span class="token function">findMethodToInvoke</span><span class="token punctuation">(</span>methodRef<span class="token punctuation">)</span> 
    newFrame <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NewFrame</span><span class="token punctuation">(</span>toBeInvoked<span class="token punctuation">)</span> 
    frame<span class="token punctuation">.</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushFrame</span><span class="token punctuation">(</span>newFrame<span class="token punctuation">)</span> 
    <span class="token function">passArgs</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> newFrame<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>方法的最后一条指令是某个返回指令，这个指令负责把方法的返回值推入前一帧的操作数栈顶，然后把当前帧从Java虚拟机栈中弹出。将在7.4小节讨论返回指令，在7.5小节讨论方法调用指令。</p> <h4 id="_7-2-解析方法符号引用"><a href="#_7-2-解析方法符号引用" class="header-anchor">#</a> 7.2 解析方法符号引用</h4> <p>非接口方法符号引用和接口方法符号引用的解析规则是不同的，因此本章分开讨论这两种符号引用。Java虚拟机规范的5.4.3.3节和5.4.3.4节详细描述了这两种符号引用的解析规则。由于本书不讨论接口的静态方法和默认方法，所以在本小节中，主要参考Java虚拟机规范第7版编写代码，请读者注意这一点。</p> <h5 id="_7-2-1-非接口方法符号引用"><a href="#_7-2-1-非接口方法符号引用" class="header-anchor">#</a> 7.2.1 非接口方法符号引用</h5> <p>打开ch07\rtda\heap\cp_methodref.go文件，在其中实现ResolvedMethod（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>MethodRef<span class="token punctuation">)</span> <span class="token function">ResolvedMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Method <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        self<span class="token punctuation">.</span><span class="token function">resolveMethodRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>method 
<span class="token punctuation">}</span>
</code></pre></div><p>如果还没有解析过符号引用，调用resolveMethodRef（）方法进行解析，否则直接返回方法指针。resolveMethodRef（）方法的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>MethodRef<span class="token punctuation">)</span> <span class="token function">resolveMethodRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    d <span class="token operator">:=</span> self<span class="token punctuation">.</span>cp<span class="token punctuation">.</span>class 
    c <span class="token operator">:=</span> self<span class="token punctuation">.</span><span class="token function">ResolvedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">IsInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IncompatibleClassChangeError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    method <span class="token operator">:=</span> <span class="token function">lookupMethod</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NoSuchMethodError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">isAccessibleTo</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IllegalAccessError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    self<span class="token punctuation">.</span>method <span class="token operator">=</span> method
<span class="token punctuation">}</span>
</code></pre></div><p>如果类D想通过方法符号引用访问类C的某个方法，先要解析符号引用得到类C。如果C是接口，则抛出IncompatibleClassChangeError异常，否则根据方法名和描述符查找方法。如果找不到对应的方法，则抛出NoSuchMethodError异常，否则检查类D是否有权限访问该方法。如果没有，则抛出IllegalAccessError异常。isAccessibleTo（）方法是在ClassMember结构体中定义的，在第6章就已经实现了。下面看一下lookupMethod（）函数，其代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">lookupMethod</span><span class="token punctuation">(</span>class <span class="token operator">*</span>Class<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Method <span class="token punctuation">{</span> 
    method <span class="token operator">:=</span> <span class="token function">LookupMethodInClass</span><span class="token punctuation">(</span>class<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        method <span class="token operator">=</span> <span class="token function">lookupMethodInInterfaces</span><span class="token punctuation">(</span>class<span class="token punctuation">.</span>interfaces<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> method 
<span class="token punctuation">}</span>
</code></pre></div><p>先从C的继承层次中找，如果找不到，就去C的接口中找。LookupMethodInClass（）函数在很多地方都要用到，所以在ch07\rtda\heap\method_lookup.go文件中实现它，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">LookupMethodInClass</span><span class="token punctuation">(</span>class <span class="token operator">*</span>Class<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Method <span class="token punctuation">{</span> 
    <span class="token keyword">for</span> c <span class="token operator">:=</span> class<span class="token punctuation">;</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> c <span class="token operator">=</span> c<span class="token punctuation">.</span>superClass <span class="token punctuation">{</span> 
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> method <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>methods <span class="token punctuation">{</span> 
            <span class="token keyword">if</span> method<span class="token punctuation">.</span>name <span class="token operator">==</span> name <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span>descriptor <span class="token operator">==</span> descriptor <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> method 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>lookupMethodInInterfaces（）函数也在method_lookup.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">lookupMethodInInterfaces</span><span class="token punctuation">(</span>ifaces <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Class<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Method <span class="token punctuation">{</span> 
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> iface <span class="token operator">:=</span> <span class="token keyword">range</span> ifaces <span class="token punctuation">{</span> 
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> method <span class="token operator">:=</span> <span class="token keyword">range</span> iface<span class="token punctuation">.</span>methods <span class="token punctuation">{</span> 
            <span class="token keyword">if</span> method<span class="token punctuation">.</span>name <span class="token operator">==</span> name <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span>descriptor <span class="token operator">==</span> descriptor <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> method 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span>
        method <span class="token operator">:=</span> <span class="token function">lookupMethodInInterfaces</span><span class="token punctuation">(</span>iface<span class="token punctuation">.</span>interfaces<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span> 
        <span class="token keyword">if</span> method <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> method 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>至此，非接口方法符号引用的解析就介绍完了，下面介绍接口方法符号引用如何解析。</p> <h5 id="_7-2-2-接口方法符号引用"><a href="#_7-2-2-接口方法符号引用" class="header-anchor">#</a> 7.2.2 接口方法符号引用</h5> <p>打开ch07\rtda\heap\cp_interface_methodref.go文件，在其中实现ResolvedInterfaceMethod（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>InterfaceMethodRef<span class="token punctuation">)</span> <span class="token function">ResolvedInterfaceMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Method <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        self<span class="token punctuation">.</span> <span class="token function">resolveInterfaceMethodRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>method 
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码和ResolvedMethod（）方法大同小异，不多解释。下面来看resolveInterface-MethodRef（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>InterfaceMethodRef<span class="token punctuation">)</span> <span class="token function">resolveInterfaceMethodRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    d <span class="token operator">:=</span> self<span class="token punctuation">.</span>cp<span class="token punctuation">.</span>class 
    c <span class="token operator">:=</span> self<span class="token punctuation">.</span><span class="token function">ResolvedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">IsInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IncompatibleClassChangeError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    method <span class="token operator">:=</span> <span class="token function">lookupInterfaceMethod</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NoSuchMethodError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">isAccessibleTo</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IllegalAccessError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    self<span class="token punctuation">.</span>method <span class="token operator">=</span> method 
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码和resolveMethodRef（）方法也差不多，但有两处差别，已经用粗体显示。下面来看lookupInterfaceMethod（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">lookupInterfaceMethod</span><span class="token punctuation">(</span>iface <span class="token operator">*</span>Class<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Method <span class="token punctuation">{</span> 
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> method <span class="token operator">:=</span> <span class="token keyword">range</span> iface<span class="token punctuation">.</span>methods <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> method<span class="token punctuation">.</span>name <span class="token operator">==</span> name <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span>descriptor <span class="token operator">==</span> descriptor <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> method 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">lookupMethodInInterfaces</span><span class="token punctuation">(</span>iface<span class="token punctuation">.</span>interfaces<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>如果能在接口中找到方法，就返回找到的方法，否则调用lookupMethodInInterfaces()函数在超接口中寻找。
lookupMethodInInterfaces()函数已经在前一小节介绍。至此，接口方法符号引用的解析也介绍完毕了，下面讨论如何给方法传递参数。</p> <h4 id="_7-3-方法调用和参数传递"><a href="#_7-3-方法调用和参数传递" class="header-anchor">#</a> 7.3 方法调用和参数传递</h4> <p>在定位到需要调用的方法之后，Java虚拟机要给这个方法创建一个新的帧并把它推入Java虚拟机栈顶，然后传递参数。这个逻辑对于本章要实现的4条方法调用指令来说基本上相同，为了避免重复代码，在单独的文件中实现这个逻辑。在ch07\instructions\base目录下创建method_invoke_logic.go文件，在其中实现InvokeMethod（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">InvokeMethod</span><span class="token punctuation">(</span>invokerFrame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">,</span> method <span class="token operator">*</span>heap<span class="token punctuation">.</span>Method<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    thread <span class="token operator">:=</span> invokerFrame<span class="token punctuation">.</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    newFrame <span class="token operator">:=</span> thread<span class="token punctuation">.</span><span class="token function">NewFrame</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> 
    thread<span class="token punctuation">.</span><span class="token function">PushFrame</span><span class="token punctuation">(</span>newFrame<span class="token punctuation">)</span> 
    argSlotSlot <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">ArgSlotCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> argSlotSlot <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> argSlotSlot <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span> 
            slot <span class="token operator">:=</span> invokerFrame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PopSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            newFrame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetSlot</span><span class="token punctuation">(</span><span class="token function">uint</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> slot<span class="token punctuation">)</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>函数的前三行代码创建新的帧并推入Java虚拟机栈，剩下的代码传递参数。重点讨论参数传递。首先，要确定方法的参数在局部变量表中占用多少位置。注意，这个数量并不一定等于从Java代码中看到的参数个数，原因有两个。第一，long和double类型的参数要占用两个位置。第二，对于实例方法，Java编译器会在参数列表的前面添加一个参数，这个隐藏的参数就是this引用。假设实际的参数占据n个位置，依次把这n个变量从调用者的操作数栈中弹出，放进被调用方法的局部变量表中，参数传递就完成了。
注意，在代码中，并没有对long和double类型做特别处理。因为操作的是Slot结构体，所以这是没问题的。LocalVars结构体的SetSlot（）方法是新增的，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self LocalVars<span class="token punctuation">)</span> <span class="token function">SetSlot</span><span class="token punctuation">(</span>index <span class="token builtin">uint</span><span class="token punctuation">,</span> slot Slot<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    self<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> slot 
<span class="token punctuation">}</span>
</code></pre></div><p>如果忽略long和double类型参数，则静态方法的参数传递过程如图7-1所示。
<img src="/jvmgo-doc/assets/img/7-1.e22b7182.png" alt="7-1">
图7-1 静态方法参数传递示意图
实例方法的参数传递过程如图7-2所示。
<img src="/jvmgo-doc/assets/img/7-2.6c97d9d9.png" alt="7-2">
图7-2 实例方法参数传递示意图</p> <p>那么那个ArgSlotCount（）方法返回了什么呢？打开ch07\rtda\heap\method.go文件，修改Method结构体，给它添加argSlotCount字段，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Method <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    ClassMember 
    maxStack <span class="token builtin">uint</span> 
    maxLocals <span class="token builtin">uint</span> 
    code <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> 
    argSlotCount <span class="token builtin">uint</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>ArgSlotCount（）只是个Getter方法而已，代码如下：func (self *Method)</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token function">ArgSlotCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uint</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>argSlotCount 
<span class="token punctuation">}</span>
</code></pre></div><p>newMethods（）方法也需要修改，在其中计算方法的argSlotCount，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newMethods</span><span class="token punctuation">(</span>class <span class="token operator">*</span>Class<span class="token punctuation">,</span> cfMethods <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>classfile<span class="token punctuation">.</span>MemberInfo<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Method <span class="token punctuation">{</span> 
    methods <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Method<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cfMethods<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> cfMethod <span class="token operator">:=</span> <span class="token keyword">range</span> cfMethods <span class="token punctuation">{</span> 
        methods<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>Method<span class="token punctuation">{</span><span class="token punctuation">}</span> 
        methods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>class <span class="token operator">=</span> class 
        methods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyMemberInfo</span><span class="token punctuation">(</span>cfMethod<span class="token punctuation">)</span> 
        methods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyAttributes</span><span class="token punctuation">(</span>cfMethod<span class="token punctuation">)</span> 
        methods<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">calcArgSlotCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> methods 
<span class="token punctuation">}</span>
</code></pre></div><p>下面是calcArgSlotCount（）方法的代码。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Method<span class="token punctuation">)</span> <span class="token function">calcArgSlotCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    parsedDescriptor <span class="token operator">:=</span> <span class="token function">parseMethodDescriptor</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span> 
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> paramType <span class="token operator">:=</span> <span class="token keyword">range</span> parsedDescriptor<span class="token punctuation">.</span>parameterTypes <span class="token punctuation">{</span> 
        self<span class="token punctuation">.</span>argSlotCount<span class="token operator">++</span> 
        <span class="token keyword">if</span> paramType <span class="token operator">==</span> <span class="token string">&quot;J&quot;</span> <span class="token operator">||</span> paramType <span class="token operator">==</span> <span class="token string">&quot;D&quot;</span> <span class="token punctuation">{</span> 
            self<span class="token punctuation">.</span>argSlotCount<span class="token operator">++</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">IsStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        self<span class="token punctuation">.</span>argSlotCount<span class="token operator">++</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>parseMethodDescriptor（）函数分解方法描述符，返回一个MethodDescriptor结构体实例。这个结构体定义在ch06\rtda\heap\method_descriptor.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> heap 
<span class="token keyword">type</span> MethodDescriptor <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    parameterTypes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> 
    returnType <span class="token builtin">string</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>parseMethodDescriptor（）函数定义ch06\rtda\heap\method_descriptor_parser.go文件中，为了节约篇幅，这里就不详细介绍这个函数了，感兴趣的读者请阅读随书源代码。</p> <h4 id="_7-4-返回指令"><a href="#_7-4-返回指令" class="header-anchor">#</a> 7.4 返回指令</h4> <p>方法执行完毕之后，需要把结果返回给调用方，这一工作由返回指令完成。返回指令属于控制类指令，一共有6条。其中return指令用于没有返回值的情况，areturn、ireturn、lreturn、freturn和dreturn分别用于返回引用、int、long、float和double类型的值。在ch07/instructions/control目录下创建return.go，在其中定义返回指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> control 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/rtda&quot;</span> 
<span class="token keyword">type</span> RETURN <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> <span class="token comment">// Return void from method </span>
<span class="token keyword">type</span> ARETURN <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> <span class="token comment">// Return reference from method </span>
<span class="token keyword">type</span> DRETURN <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> <span class="token comment">// Return double from method </span>
<span class="token keyword">type</span> FRETURN <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> <span class="token comment">// Return float from method </span>
<span class="token keyword">type</span> IRETURN <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> <span class="token comment">// Return int from method </span>
<span class="token keyword">type</span> LRETURN <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> <span class="token comment">// Return long from method </span>
</code></pre></div><p>6条返回指令都不需要操作数。return指令比较简单，只要把当前帧从Java虚拟机栈中弹出即可，它的Execute（）方法如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>RETURN<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    frame<span class="token punctuation">.</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PopFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>其他5条返回指令的Execute（）方法都非常相似，为了节约篇幅，下面只给出ireturn指令的代码（有差异的部分已经加粗）：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>IRETURN<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    thread <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    currentFrame <span class="token operator">:=</span> thread<span class="token punctuation">.</span><span class="token function">PopFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    invokerFrame <span class="token operator">:=</span> thread<span class="token punctuation">.</span><span class="token function">TopFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    retVal <span class="token operator">:=</span> currentFrame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    invokerFrame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushInt</span><span class="token punctuation">(</span>retVal<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Thread结构体的TopFrame（）方法和CurrentFrame（）代码一样，这里用不同的名称主要是为了避免混淆。方法符号引用解析、参数传递、结果返回等都实现了，下面实现方法调用指令。</p> <h4 id="_7-5-方法调用指令"><a href="#_7-5-方法调用指令" class="header-anchor">#</a> 7.5 方法调用指令</h4> <p>与7.2节类似，由于本书不考虑接口的静态方法和默认方法，所以要实现的这4条指令并没有完全满足Java虚拟机规范第8版的规定，请读者留意这一点。下面从较简单的invokestatic指令开始。</p> <h5 id="_7-5-1-invokestatic指令"><a href="#_7-5-1-invokestatic指令" class="header-anchor">#</a> 7.5.1 invokestatic指令</h5> <p>在ch07\instructions\references目录下创建invokestatic.go文件，在其中定义invokestatic指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> references 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/rtda/class&quot;</span> 
<span class="token comment">// Invoke a class (static) method </span>
<span class="token keyword">type</span> INVOKE_STATIC <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>Index16Instruction <span class="token punctuation">}</span> 

结构体定义比较简单，直接看Execute（）方法，代码如下：
<span class="token string">``</span>`<span class="token keyword">go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>INVOKE_STATIC<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    methodRef <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">.</span>MethodRef<span class="token punctuation">)</span> 
    resolvedMethod <span class="token operator">:=</span> methodRef<span class="token punctuation">.</span><span class="token function">ResolvedMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token operator">!</span>resolved<span class="token punctuation">.</span><span class="token function">IsStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IncompatibleClassChangeError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    base<span class="token punctuation">.</span><span class="token function">InvokeMethod</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> resolvedMethod<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>假定解析符号引用后得到方法M。M必须是静态方法，否则抛出Incompatible -ClassChangeError异常。M不能是类初始化方法。类初始化方法只能由Java虚拟机调用，不能使用invokestatic指令调用。这一规则由class文件验证器保证，这里不做检查。如果声明M的类还没有被初始化，则要先初始化该类。将在7.8小节讨论类的初始化。
对于invokestatic指令，M就是最终要执行的方法，调用InvokeMethod（）函数执行该方法。</p> <h5 id="_7-5-2-invokespecial指令"><a href="#_7-5-2-invokespecial指令" class="header-anchor">#</a> 7.5.2 invokespecial指令</h5> <p>invokespecial指令在第6章就定义好了，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Invoke instance method; special handling for superclass, private, </span>
<span class="token comment">// and instance initialization method invocations </span>
<span class="token keyword">type</span> INVOKE_SPECIAL <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>Index16Instruction <span class="token punctuation">}</span> 
</code></pre></div><p>需要修改Execute（）方法，代码稍微有些复杂，先看第一部分：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>INVOKE_SPECIAL<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    currentClass <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    cp <span class="token operator">:=</span> currentClass<span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    methodRef <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">.</span>MethodRef<span class="token punctuation">)</span> 
    resolvedClass <span class="token operator">:=</span> methodRef<span class="token punctuation">.</span><span class="token function">ResolvedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    resolvedMethod <span class="token operator">:=</span> methodRef<span class="token punctuation">.</span><span class="token function">ResolvedMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre></div><p>先拿到当前类、当前常量池、方法符号引用，然后解析符号引用，拿到解析后的类和方法。继续看代码：</p> <div class="language-go extra-class"><pre class="language-go"><code>    <span class="token keyword">if</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;&lt;init&gt;&quot;</span> <span class="token operator">&amp;&amp;</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> resolvedClass <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NoSuchMethodError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">IsStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IncompatibleClassChangeError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
</code></pre></div><p>假定从方法符号引用中解析出来的类是C，方法是M。如果M是构造函数，则声明M的类必须是C，否则抛出NoSuchMethodError异常。如果M是静态方法，则抛出Incompatible ClassChangeError异常。继续看代码：</p> <div class="language-go extra-class"><pre class="language-go"><code>    ref <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRefFromTop</span><span class="token punctuation">(</span>resolvedMethod<span class="token punctuation">.</span><span class="token function">ArgSlotCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> ref <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NullPointerException&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
</code></pre></div><p>从操作数栈中弹出this引用，如果该引用是null，抛出NullPointerException异常。注意，在传递参数之前，不能破坏操作数栈的状态。给OperandStack结构体添加一个GetRefFromTop（）方法，该方法返回距离操作数栈顶n个单元格的引用变量。比如GetRefFromTop（0）返回操作数栈顶引用，GetRefFromTop（1）返回从栈顶开始的倒数第二个引用，等等。GetRefFromTop（）方法的代码很简单，在后面给出。继续看Execute（）方法：</p> <div class="language-go extra-class"><pre class="language-go"><code>    <span class="token keyword">if</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">IsProtected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
      resolvedMethod<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSuperClassOf</span><span class="token punctuation">(</span>currentClass<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
      resolvedMethod<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> currentClass<span class="token punctuation">.</span><span class="token function">GetPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
      ref<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> currentClass <span class="token operator">&amp;&amp;</span> 
      <span class="token operator">!</span>ref<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSubClassOf</span><span class="token punctuation">(</span>currentClass<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IllegalAccessError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
</code></pre></div><p>上面的判断确保protected方法只能被声明该方法的类或子类调用。如果违反这一规定，则抛出IllegalAccessError异常。接着往下看：</p> <div class="language-go extra-class"><pre class="language-go"><code>    methodToBeInvoked <span class="token operator">:=</span> resolvedMethod 
    <span class="token keyword">if</span> currentClass<span class="token punctuation">.</span><span class="token function">IsSuper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> resolvedClass<span class="token punctuation">.</span><span class="token function">IsSuperClassOf</span><span class="token punctuation">(</span>currentClass<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">&quot;&lt;init&gt;&quot;</span> <span class="token punctuation">{</span> 
        methodToBeInvoked <span class="token operator">=</span> heap<span class="token punctuation">.</span><span class="token function">LookupMethodInClass</span><span class="token punctuation">(</span>currentClass<span class="token punctuation">.</span><span class="token function">SuperClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        methodRef<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodRef<span class="token punctuation">.</span><span class="token function">Descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
</code></pre></div><p>上面这段代码比较难懂，把它翻译成更容易理解的语言：如果调用的中超类中的函数，但不是构造函数，且当前类的ACC_SUPER标志被设置，需要一个额外的过程查找最终要调用的方法；否则前面从方法符号引用中解析出来的方法就是要调用的方法。</p> <div class="language-go extra-class"><pre class="language-go"><code>    <span class="token keyword">if</span> methodToBeInvoked <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> methodToBeInvoked<span class="token punctuation">.</span><span class="token function">IsAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.AbstractMethodError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    base<span class="token punctuation">.</span><span class="token function">InvokeMethod</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> methodtoBeInvoked<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>如果查找过程失败，或者找到的方法是抽象的，抛出AbstractMethodError异常。最后，如果一切正常，就调用方法。这里之所以这么复杂，是因为调用超类的（非构造函数）方法需要特别处理。限于篇幅，这里就不深入讨论了，读者可以阅读Java虚拟机规范，了解类的ACC_SUPER访问标志的用法。OperandStack结构体GetRefFromTop（）方法的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>OperandStack<span class="token punctuation">)</span> <span class="token function">GetRefFromTop</span><span class="token punctuation">(</span>n <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token operator">*</span>heap<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>slots<span class="token punctuation">[</span>self<span class="token punctuation">.</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>ref 
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_7-5-3-invokevirtual指令"><a href="#_7-5-3-invokevirtual指令" class="header-anchor">#</a> 7.5.3 invokevirtual指令</h5> <p>invokevirtual指令也已经在第6章定义好了，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Invoke instance method; dispatch based on class </span>
<span class="token keyword">type</span> INVOKE_VIRTUAL <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>Index16Instruction <span class="token punctuation">}</span> 
</code></pre></div><p>下面修改Execute（）方法，第一部分代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>INVOKE_VIRTUAL<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    currentClass <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    cp <span class="token operator">:=</span> currentClass<span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    methodRef <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">.</span>MethodRef<span class="token punctuation">)</span> 
    resolvedMethod <span class="token operator">:=</span> methodRef<span class="token punctuation">.</span><span class="token function">ResolvedMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">IsStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IncompatibleClassChangeError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    ref <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRefFromTop</span><span class="token punctuation">(</span>resolvedMethod<span class="token punctuation">.</span><span class="token function">ArgSlotCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> ref <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token comment">// hack System.out.println() </span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NullPointerException&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">IsProtected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
      resolvedMethod<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSuperClassOf</span><span class="token punctuation">(</span>currentClass<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
      resolvedMethod<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> currentClass<span class="token punctuation">.</span><span class="token function">GetPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
      ref<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> currentClass <span class="token operator">&amp;&amp;</span> 
      <span class="token operator">!</span>ref<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSubClassOf</span><span class="token punctuation">(</span>currentClass<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IllegalAccessError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
</code></pre></div><p>这部分代码和invokespecial指令基本上差不多，也不多解释了。下面是剩下的代码。</p> <div class="language-go extra-class"><pre class="language-go"><code>    methodToBeInvoked <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">LookupMethodInClass</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    methodRef<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodRef<span class="token punctuation">.</span><span class="token function">Descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> methodToBeInvoked <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> methodToBeInvoked<span class="token punctuation">.</span><span class="token function">IsAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.AbstractMethodError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    base<span class="token punctuation">.</span><span class="token function">InvokeMethod</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> methodToBeInvoked<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>从对象的类中查找真正要调用的方法。如果找不到方法，或者找到的是抽象方法，则需要抛出AbstractMethodError异常，否则一切正常，调用方法。注意，仍然要用hack的方式调用System.out.println（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>INVOKE_VIRTUAL<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
    ref <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRefFromTop</span><span class="token punctuation">(</span>resolvedMethod<span class="token punctuation">.</span><span class="token function">ArgSlotCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> ref <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token comment">// hack! </span>
        <span class="token keyword">if</span> methodRef<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;println&quot;</span> <span class="token punctuation">{</span> 
            <span class="token function">_println</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodRef<span class="token punctuation">.</span><span class="token function">Descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span> 
        <span class="token punctuation">}</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NullPointerException&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
<span class="token punctuation">}</span> 
</code></pre></div><p>_println（）函数如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">_println</span><span class="token punctuation">(</span>stack <span class="token operator">*</span>rtda<span class="token punctuation">.</span>OperandStack<span class="token punctuation">,</span> descriptor <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">switch</span> descriptor <span class="token punctuation">{</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;(Z)V&quot;</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;(C)V&quot;</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%c\n&quot;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;(B)V&quot;</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;(S)V&quot;</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;(I)V&quot;</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;(F)V&quot;</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">PopFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">PopLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token string">&quot;(D)V&quot;</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">PopDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;println: &quot;</span> <span class="token operator">+</span> descriptor<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    stack<span class="token punctuation">.</span><span class="token function">PopRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_7-5-4-invokeinterface指令"><a href="#_7-5-4-invokeinterface指令" class="header-anchor">#</a> 7.5.4 invokeinterface指令</h5> <p>在ch07\instructions\references目录下创建invokeinterface.go文件，在其中定义invokeinterface指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> references 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/rtda/heap&quot;</span> 
<span class="token comment">// Invoke interface method </span>
<span class="token keyword">type</span> INVOKE_INTERFACE <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    index <span class="token builtin">uint</span>
    <span class="token comment">// count uint8 </span>
    <span class="token comment">// zero uint8 </span>
<span class="token punctuation">}</span> 
</code></pre></div><p>注意，和其他三条方法调用指令略有不同，在字节码中，invokeinterface指令的操作码后面跟着4字节而非2字节。前两字节的含义和其他指令相同，是个uint16运行时常量池索引。第3字节的值是给方法传递参数需要的slot数，其含义和给Method结构体定义的argSlotCount字段相同。正如我们所知，这个数是可以根据方法描述符计算出来的，它的存在仅仅是因为历史原因。第4字节是留给Oracle的某些Java虚拟机实现用的，它的值必须是0。该字节的存在是为了保证Java虚拟机可以向后兼容。
invokeinterface指令的FetchOperands（）方法如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>INVOKE_INTERFACE<span class="token punctuation">)</span> <span class="token function">FetchOperands</span><span class="token punctuation">(</span>reader <span class="token operator">*</span>base<span class="token punctuation">.</span>BytecodeReader<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    self<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token function">uint</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">ReadUint16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    reader<span class="token punctuation">.</span><span class="token function">ReadUint8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// count </span>
    reader<span class="token punctuation">.</span><span class="token function">ReadUint8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// must be 0 </span>
<span class="token punctuation">}</span> 
</code></pre></div><p>下面看Execute（）方法，第一部分代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>INVOKE_INTERFACE<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    methodRef <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">.</span>InterfaceMethodRef<span class="token punctuation">)</span> 
    resolvedMethod <span class="token operator">:=</span> methodRef<span class="token punctuation">.</span><span class="token function">ResolvedInterfaceMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">IsStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">IsPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IncompatibleClassChangeError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
</code></pre></div><p>先从运行时常量池中拿到并解析接口方法符号引用，如果解析后的方法是静态方法或私有方法，则抛出IncompatibleClassChangeError异常。继续看代码：</p> <div class="language-go extra-class"><pre class="language-go"><code>ref <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRefFromTop</span><span class="token punctuation">(</span>resolvedMethod<span class="token punctuation">.</span><span class="token function">ArgSlotCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> ref <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NullPointerException&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ref<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsImplements</span><span class="token punctuation">(</span>methodRef<span class="token punctuation">.</span><span class="token function">ResolvedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IncompatibleClassChangeError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
</code></pre></div><p>从操作数栈中弹出this引用，如果引用是null，则抛出NullPointerException异常。如果引用所指对象的类没有实现解析出来的接口，则抛出IncompatibleClassChangeError异常。继续看代码：</p> <div class="language-go extra-class"><pre class="language-go"><code>    methodToBeInvoked <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">LookupMethodInClass</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    methodRef<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodRef<span class="token punctuation">.</span><span class="token function">Descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> methodToBeInvoked <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> methodToBeInvoked<span class="token punctuation">.</span><span class="token function">IsAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.AbstractMethodError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>methodToBeInvoked<span class="token punctuation">.</span><span class="token function">IsPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IllegalAccessError&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
</code></pre></div><p>查找最终要调用的方法。如果找不到，或者找到的方法是抽象的，则抛出Abstract-MethodError异常。如果找到的方法不是public，则抛出IllegalAccessError异常，否则，一切正常，调用方法：</p> <div class="language-go extra-class"><pre class="language-go"><code>    base<span class="token punctuation">.</span><span class="token function">InvokeMethod</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> methodToBeInvoked<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>至此，4条方法调用指令都实现完毕了。再总结一下这4条指令的用途。invokestatic指令调用静态方法，很好理解。invokespecial指令也比较好理解。首先，因为私有方法和构造函数不需要动态绑定，所以invokespecial指令可以加快方法调用速度。其次，使用super关键字调用超类中的方法不能使用invokevirtual指令，否则会陷入无限循环。</p> <p>那么为什么要单独定义invokeinterface指令呢？统一使用invokevirtual指令不行吗？答案是，可以，但是可能会影响效率。这两条指令的区别在于：当Java虚拟机通过invokevirtual调用方法时，this引用指向某个类（或其子类）的实例。因为类的继承层次是固定的，所以虚拟机可以使用一种叫作vtable（Virtual Method Table）的技术加速方法查找。但是当通过invokeinterface指令调用接口方法时，因为this引用可以指向任何实现了该接口的类的实例，所以无法使用vtable技术。</p> <p>由于篇幅限制，这里就不深入讨论vtable技术了。感兴趣的读者可以阅读相关资料，或者改进我们的代码，给invokevirtual指令增加vtable优化。</p> <p>4条方法调用指令和6条返回指令都准备好了，还需要修改ch07\instructions\factor -y.go文件，在其中增加这些指令的case语句。鉴于改动比较简单，这里就不给出代码了。</p> <h4 id="_7-6-改进解释器"><a href="#_7-6-改进解释器" class="header-anchor">#</a> 7.6 改进解释器</h4> <p>我们的解释器目前只能执行单个方法，现在就扩展它，让它支持方法调用。打开ch07\interpreter.go文件，修改interpret（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">interpret</span><span class="token punctuation">(</span>method <span class="token operator">*</span>heap<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> logInst <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    thread <span class="token operator">:=</span> rtda<span class="token punctuation">.</span><span class="token function">NewThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    frame <span class="token operator">:=</span> thread<span class="token punctuation">.</span><span class="token function">NewFrame</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> 
    thread<span class="token punctuation">.</span><span class="token function">PushFrame</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span> 
    <span class="token keyword">defer</span> <span class="token function">catchErr</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span> 
    <span class="token function">loop</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> logInst<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>logInst参数控制是否把指令执行信息打印到控制台。更重要的变化在loop（）函数中，代码如下所示：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">loop</span><span class="token punctuation">(</span>thread <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Thread<span class="token punctuation">,</span> logInst <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    reader <span class="token operator">:=</span> <span class="token operator">&amp;</span>base<span class="token punctuation">.</span>BytecodeReader<span class="token punctuation">{</span><span class="token punctuation">}</span> 
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        frame <span class="token operator">:=</span> thread<span class="token punctuation">.</span><span class="token function">CurrentFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        pc <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">NextPC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        thread<span class="token punctuation">.</span><span class="token function">SetPC</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span> 
        <span class="token comment">// decode </span>
        reader<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pc<span class="token punctuation">)</span> 
        opcode <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUint8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        inst <span class="token operator">:=</span> instructions<span class="token punctuation">.</span><span class="token function">NewInstruction</span><span class="token punctuation">(</span>opcode<span class="token punctuation">)</span> 
        inst<span class="token punctuation">.</span><span class="token function">FetchOperands</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span> 
        frame<span class="token punctuation">.</span><span class="token function">SetNextPC</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">PC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logInst<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token function">logInstruction</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> inst<span class="token punctuation">)</span> 
        <span class="token punctuation">}</span>
        <span class="token comment">// execute </span>
        inst<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span> 
        <span class="token keyword">if</span> thread<span class="token punctuation">.</span><span class="token function">IsStackEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">break</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>在每次循环开始，先拿到当前帧，然后根据pc从当前方法中解码出一条指令。指令执行完毕之后，判断Java虚拟机栈中是否还有帧。如果没有则退出循环；否则继续。Thread结构体的IsStackEmpty（）方法是新增加的，代码在ch07\rtda\thread.go中，如下所示：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Thread<span class="token punctuation">)</span> <span class="token function">IsStackEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>它只是调用了Stack结构体的isEmpty（）方法，代码在ch07\rtda\jvm_stack.go中，如下所示：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Stack<span class="token punctuation">)</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_top <span class="token operator">==</span> <span class="token boolean">nil</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>回到interpreter.go，如果解释器在执行期间出现了问题，catchErr（）函数会打印出错信息，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">catchErr</span><span class="token punctuation">(</span>thread <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">logFrames</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>logFrames（）函数打印Java虚拟机栈信息，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">logFrames</span><span class="token punctuation">(</span>thread <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">for</span> <span class="token operator">!</span>thread<span class="token punctuation">.</span><span class="token function">IsStackEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        frame <span class="token operator">:=</span> thread<span class="token punctuation">.</span><span class="token function">PopFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        method <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        className <span class="token operator">:=</span> method<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt; pc:%4d %v.%v%v \n&quot;</span><span class="token punctuation">,</span> 
        frame<span class="token punctuation">.</span><span class="token function">NextPC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> className<span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">Descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>logInstruction（）函数在方法执行过程中打印指令信息，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">logInstruction</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">,</span> inst base<span class="token punctuation">.</span>Instruction<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    method <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    className <span class="token operator">:=</span> method<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    methodName <span class="token operator">:=</span> method<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    pc <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v.%v() #%2d %T %v\n&quot;</span><span class="token punctuation">,</span> className<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> pc<span class="token punctuation">,</span> inst<span class="token punctuation">,</span> inst<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>解释器改造完毕，下面测试方法调用。</p> <h4 id="_7-7-测试方法调用"><a href="#_7-7-测试方法调用" class="header-anchor">#</a> 7.7 测试方法调用</h4> <p>先改造命令行工具，给它增加两个选项。java命令提供了-verbose：class（简写为-verbose）选项，可以控制是否把类加载信息输出到控制台。也增加这样一个选项，另外参照这个选项增加一个-verbose：inst选项，用来控制是否把指令执行信息输出到控制台。
打开ch07\cmd.go文件，修改Cmd结构体如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Cmd <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    helpFlag <span class="token builtin">bool</span> 
    versionFlag <span class="token builtin">bool</span> 
    verboseClassFlag <span class="token builtin">bool</span> 
    verboseInstFlag <span class="token builtin">bool</span> 
    cpOption <span class="token builtin">string</span> 
    XjreOption <span class="token builtin">string</span> 
    class <span class="token builtin">string</span> 
    args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>parseCmd（）函数也需要修改，改动比较简单，这里就不给出代码了。下面修改ch07\main.go文件，其他地方不变，只需要修改startJVM（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">startJVM</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>Cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> classpath<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>XjreOption<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>cpOption<span class="token punctuation">)</span> 
    classLoader <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">NewClassLoader</span><span class="token punctuation">(</span>cp<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>verboseClassFlag<span class="token punctuation">)</span> 
    className <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
    mainClass <span class="token operator">:=</span> classLoader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> 
    mainMethod <span class="token operator">:=</span> mainClass<span class="token punctuation">.</span><span class="token function">GetMainMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> mainMethod <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">interpret</span><span class="token punctuation">(</span>mainMethod<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>verboseInstFlag<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Main method not found in class %s\n&quot;</span><span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>class<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>然后修改ch07\rtda\heap\class_loader.go文件，给ClassLoader结构体添加verboseFlag字段，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> ClassLoader <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    cp <span class="token operator">*</span>classpath<span class="token punctuation">.</span>Classpath 
    verboseFlag <span class="token builtin">bool</span> 
    classMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Class 
<span class="token punctuation">}</span> 
</code></pre></div><p>NewClassLoader（）函数要相应修改，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewClassLoader</span><span class="token punctuation">(</span>cp <span class="token operator">*</span>classpath<span class="token punctuation">.</span>Classpath<span class="token punctuation">,</span> verboseFlag <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>ClassLoader <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>ClassLoader<span class="token punctuation">{</span> 
        cp<span class="token punctuation">:</span> cp<span class="token punctuation">,</span> 
        verboseFlag<span class="token punctuation">:</span> verboseFlag<span class="token punctuation">,</span> 
        classMap<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Class<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>loadNonArrayClass（）函数也要修改，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ClassLoader<span class="token punctuation">)</span> <span class="token function">loadNonArrayClass</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Class <span class="token punctuation">{</span> 
    data<span class="token punctuation">,</span> entry <span class="token operator">:=</span> self<span class="token punctuation">.</span><span class="token function">readClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> 
    class <span class="token operator">:=</span> self<span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> 
    <span class="token function">link</span><span class="token punctuation">(</span>class<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>verboseFlag <span class="token punctuation">{</span> 
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;[Loaded %s from %s]\n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> class 
<span class="token punctuation">}</span>
</code></pre></div><p>一切都准备就绪，打开命令行窗口，执行下面的命令编译本章代码：</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>go <span class="token function">install</span> jvmgo<span class="token punctuation">\</span>ch07 
</code></pre></div><p>命令执行完毕后，在D：\go\workspace\bin目录下出现ch07.exe文件。下面这个类演示了各种情况下，4种方法调用命令的使用。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch07</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InvokeDemo</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">new</span> <span class="token class-name">InvokeDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">InvokeDemo</span><span class="token punctuation">.</span><span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// invokestatic </span>
        <span class="token class-name">InvokeDemo</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokeDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// invokespecial </span>
        demo<span class="token punctuation">.</span><span class="token function">instanceMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// invokespecial </span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// invokespecial </span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// invokevirtual </span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span><span class="token punctuation">)</span> demo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// invokeinterface </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">instanceMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>用javac编译InvokeDemo类，然后用ch07.exe执行InvokeDemo程序，可以看到程序正常执行（没有任何输出），如图7-3所示。
<img src="/jvmgo-doc/assets/img/7-3.4cd8c3fe.png" alt="7-3">
图7-3 InvokeDemo执行结果</p> <p>InvokeDemo只是演示，下面看一个稍微复杂一些的例子。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch07</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FibonacciTest</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">long</span> x <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> n<span class="token punctuation">;</span> <span class="token punctuation">}</span> 
        <span class="token keyword">return</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>FibonacciTest类演示了斐波那契数列的计算，用javac编译它，然后用ch07.exe执行，结果如图7-4所示。
<img src="/jvmgo-doc/assets/img/7-4.cd26cbd3.png" alt="7-4">
图7-4 FibonacciTest执行结果
几秒钟停顿之后，控制台上打印出了832040。我们的Java虚拟机终于可以执行复杂计算了。方法调用指令就测试到这里，下面在本章的最后，讨论类的初始化。</p> <h4 id="_7-8-类初始化"><a href="#_7-8-类初始化" class="header-anchor">#</a> 7.8 类初始化</h4> <p>第6章实现了一个简化版的类加载器，可以把类加载到方法区中。但是因为当时还没有实现方法调用，所以没有办法初始化类。现在可以把这个逻辑补上了。我们已经知道，类初始化就是执行类的初始化方法（<code>&lt;clinit&gt;</code>）。类的初始化在下列情况下触发：</p> <ul><li>执行new指令创建类实例，但类还没有被初始化。</li> <li>执行putstatic、getstatic指令存取类的静态变量，但声明该字段的类还没有被初始化。</li> <li>执行invokestatic调用类的静态方法，但声明该方法的类还没有被初始化。</li> <li>当初始化一个类时，如果类的超类还没有被初始化，要先初始化类的超类。</li> <li>执行某些反射操作时。
为了判断类是否已经初始化，需要给Class结构体添加一个字段：</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Class <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他字段 </span>
    initStarted <span class="token builtin">bool</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>类的初始化其实分为几个阶段，但由于我们的类加载器还不够完善，所以先使用一个简单的布尔状态就足够了。initStarted字段表示类的<code>&lt;clinit&gt;</code>方法是否已经开始执行。接下来给Class结构体添加两个方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">InitStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>initStarted 
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">StartInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    self<span class="token punctuation">.</span>initStarted <span class="token operator">=</span> <span class="token boolean">true</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>InitStarted（）是Getter方法，返回initStarted字段值。StartInit（）方法把initStarted字段设置成true。下面修改new指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>NEW<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    classRef <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">.</span>ClassRef<span class="token punctuation">)</span> 
    class <span class="token operator">:=</span> classRef<span class="token punctuation">.</span><span class="token function">ResolvedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token operator">!</span>class<span class="token punctuation">.</span><span class="token function">InitStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        frame<span class="token punctuation">.</span><span class="token function">RevertNextPC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        base<span class="token punctuation">.</span><span class="token function">InitClass</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> class<span class="token punctuation">)</span> 
        <span class="token keyword">return</span> 
    <span class="token punctuation">}</span>
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
<span class="token punctuation">}</span> 
</code></pre></div><p>putstatic和getstatic指令改动类似，以putstatic指令为例，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>PUT_STATIC<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
    field <span class="token operator">:=</span> fieldRef<span class="token punctuation">.</span><span class="token function">ResolvedField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    class <span class="token operator">:=</span> field<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token operator">!</span>class<span class="token punctuation">.</span><span class="token function">InitStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        frame<span class="token punctuation">.</span><span class="token function">RevertNextPC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        base<span class="token punctuation">.</span><span class="token function">InitClass</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> class<span class="token punctuation">)</span> 
        <span class="token keyword">return</span> 
    <span class="token punctuation">}</span>
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>invokestatic指令也需要修改，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>INVOKE_STATIC<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
    class <span class="token operator">:=</span> resolvedMethod<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token operator">!</span>class<span class="token punctuation">.</span><span class="token function">InitStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        frame<span class="token punctuation">.</span><span class="token function">RevertNextPC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        base<span class="token punctuation">.</span><span class="token function">InitClass</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> class<span class="token punctuation">)</span> 
        <span class="token keyword">return</span> 
    <span class="token punctuation">}</span>
    base<span class="token punctuation">.</span><span class="token function">InvokeMethod</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> resolvedMethod<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>4条指令都修改完毕了，但是新增加的代码做了些什么？先判断类的初始化是否已经开始，如果还没有，则需要调用类的初始化方法，并终止指令执行。但是由于此时指令已经执行到了一半，也就是说当前帧的nextPC字段已经指向下一条指令，所以需要修改nextPC，让它重新指向当前指令。Frame结构体的RevertNextPC（）方法做了这样的操作，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Frame<span class="token punctuation">)</span> <span class="token function">RevertNextPC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    self<span class="token punctuation">.</span>nextPC <span class="token operator">=</span> self<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>pc 
<span class="token punctuation">}</span>
</code></pre></div><p>nextPC调整好之后，下一步查找并调用类的初始化方法。这个逻辑是通用的，在ch07 \instructions\base\class_init_logic.go文件中实现它，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">InitClass</span><span class="token punctuation">(</span>thread <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Thread<span class="token punctuation">,</span> class <span class="token operator">*</span>heap<span class="token punctuation">.</span>Class<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    class<span class="token punctuation">.</span><span class="token function">StartInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token function">scheduleClinit</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> class<span class="token punctuation">)</span> 
    <span class="token function">initSuperClass</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> class<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>InitClass（）函数先调用StartInit（）方法把类的initStarted状态设置成true以免进入死循环，然后调用scheduleClinit（）函数准备执行类的初始化方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">scheduleClinit</span><span class="token punctuation">(</span>thread <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Thread<span class="token punctuation">,</span> class <span class="token operator">*</span>heap<span class="token punctuation">.</span>Class<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    clinit <span class="token operator">:=</span> class<span class="token punctuation">.</span><span class="token function">GetClinitMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> clinit <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token comment">// exec &lt;clinit&gt; </span>
        newFrame <span class="token operator">:=</span> thread<span class="token punctuation">.</span><span class="token function">NewFrame</span><span class="token punctuation">(</span>clinit<span class="token punctuation">)</span> 
        thread<span class="token punctuation">.</span><span class="token function">PushFrame</span><span class="token punctuation">(</span>newFrame<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>类初始化方法没有参数，所以不需要传递参数。Class结构体的GetClinitMethod（）方法如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">GetClinitMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Method <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">getStaticMethod</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;clinit&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>注意，这里有意使用了scheduleClinit这个函数名而非invokeClinit，因为有可能要先执行超类的初始化方法，如函数initSuperClass（）所示。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">initSuperClass</span><span class="token punctuation">(</span>thread <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Thread<span class="token punctuation">,</span> class <span class="token operator">*</span>heap<span class="token punctuation">.</span>Class<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token operator">!</span>class<span class="token punctuation">.</span><span class="token function">IsInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        superClass <span class="token operator">:=</span> class<span class="token punctuation">.</span><span class="token function">SuperClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token keyword">if</span> superClass <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>superClass<span class="token punctuation">.</span><span class="token function">InitStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token function">InitClass</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> superClass<span class="token punctuation">)</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>如果超类的初始化还没有开始，就递归调用InitClass（）函数执行超类的初始化方法，这样可以保证超类的初始化方法对应的帧在子类上面，使超类初始化方法先于子类执行。
类的初始化逻辑写完了，由于篇幅限制，这里就不进行测试了。读者可以参考随书Java示例代码，或者自行编写Java程序进行测试。不过在进行测试之前，还需要增加一个小小的hack。由于目前还不支持本地方法调用，而Java类库中的很多类都要注册本地方法，比如Object类就有一个registerNatives（）本地方法，用于注册其他方法，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.lang.Object </span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Object</span> <span class="token punctuation">{</span> 
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">static</span> <span class="token punctuation">{</span> 
        <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码 </span>
<span class="token punctuation">}</span> 
</code></pre></div><p>由于Object类是其他所有类的超类，所以这会导致Java虚拟机崩溃。解决办法是修改InvokeMethod（）函数（代码在ch07\instructions\base\method_invoke_logic.go文件中），让它跳过所有registerNatives（）方法，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> base 
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/rtda&quot;</span><span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch07/rtda/heap&quot;</span> 
<span class="token keyword">func</span> <span class="token function">InvokeMethod</span><span class="token punctuation">(</span>invokerFrame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">,</span> method <span class="token operator">*</span>heap<span class="token punctuation">.</span>Method<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token operator">...</span> <span class="token comment">// 前面的代码不变，下面是 </span>
    hack<span class="token operator">!</span>
    <span class="token keyword">if</span> method<span class="token punctuation">.</span><span class="token function">IsNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> method<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;registerNatives&quot;</span> <span class="token punctuation">{</span> 	
            thread<span class="token punctuation">.</span><span class="token function">PopFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
            <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;native method: %v.%v%v\n&quot;</span><span class="token punctuation">,</span> 
            method<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">Descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>如果遇到其他本地方法，直接调用panic（）函数终止程序执行即可。将在第9章讨论本地方法调用。</p> <h4 id="_7-9-本章小结"><a href="#_7-9-本章小结" class="header-anchor">#</a> 7.9 本章小结</h4> <p>本章讨论了方法调用和返回，并且实现了类初始化逻辑。如果说在前面几章里，我们的Java虚拟机还是个小baby只会爬的话，到了本章结尾，它已经可以满地跑了。下一章将讨论数组和字符串，届时，我们的小baby就有更多的玩具可以玩耍了。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/jvmgo-doc/assets/js/app.0e038eb3.js" defer></script><script src="/jvmgo-doc/assets/js/2.9a199717.js" defer></script><script src="/jvmgo-doc/assets/js/9.76119271.js" defer></script>
  </body>
</html>
