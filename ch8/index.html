<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自己动手写Java虚拟机</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css" as="style"><link rel="preload" href="/jvmgo-doc/assets/js/app.0e038eb3.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/2.9a199717.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/10.e6c9c852.js" as="script"><link rel="prefetch" href="/jvmgo-doc/assets/js/11.c614ad39.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/12.f2736902.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/13.6ed656c8.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/14.abed2032.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/15.6c8db65d.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/16.1b00c595.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/17.14678ca3.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/18.a4cd171a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/19.bd53fbb2.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/20.28d8d8b4.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/3.6e9095c9.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/4.2e142e62.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/5.92e59ff4.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/6.9bd6201a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/7.ab861a63.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/8.12d8c35a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/9.76119271.js">
    <link rel="stylesheet" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="第8章-数组和字符串"><a href="#第8章-数组和字符串" class="header-anchor">#</a> 第8章 数组和字符串</h2> <p>在大部分编程语言中，数组和字符串都是最基本的数据类型Java虚拟机直接支持数组，对字符串的支持则由java.lang.String和相关的类提供。本章分为两部分，前半部分讨论数组和数组相关指令，后半部分讨论字符串。</p> <p>在本章的讨论中，数组 一般指数组对象 ；在不至于引起混淆的情况下，也可能指数组类 ；在其他情况下，会明确指出是数组类还是数组对象 。如果数组的元素是基本类型，就把它叫作基本类型数组 ，否则，数组的元素是引用类型，把它叫作引用类型数组 。基本类型数组肯定都是一维数组 ，如果引用类型数组的元素也是数组，那么它就是多维数组 。</p> <p>开始学习本章之前，还是先把目录结构准备好。复制ch07目录，改名为ch08。修改main.go等文件，把import语句中的ch07全都替换成ch08。本章对目录结构没有太大的调整。</p> <h4 id="_8-1-数组概述"><a href="#_8-1-数组概述" class="header-anchor">#</a> 8.1 数组概述</h4> <p>数组在Java虚拟机中是个比较特殊的概念。为什么这么说呢？有下面几个原因：</p> <p>首先，数组类和普通的类是不同的。普通的类从class文件中加载，但是数组类由Java虚拟机在运行时生成。数组的类名是左方括号（[）+数组元素的类型描述符；数组的类型描述符就是类名本身。例如，int[]的类名是[I，int[][]的类名是[[I，Object[]的类名是[Ljava /lang/Object；，String[][]的类名是[[java/lang/String；，等等。</p> <p>其次，创建数组的方式和创建普通对象的方式不同。普通对象由new指令创建，然后由构造函数初始化。基本类型数组由newarray指令创建；引用类型数组由anewarray指令创建；另外还有一个专门的multianewarray指令用于创建多维数组。</p> <p>最后，很显然，数组和普通对象存放的数据也是不同的。普通对象中存放的是实例变量，通过putfield和getfield指令存取。数组对象中存放的则是数组元素，通过<code>&lt;t&gt;aload</code>和<code>&lt;t&gt;astore</code>系列指令按索引存取。其中<code>&lt;t&gt;</code>可以是a、b、c、d、f、i、l或者s，分别用于存取引用、byte、char、double、float、int、long或short类型的数组。另外，还有一个arraylength指令，用于获取数组长度。</p> <p>Java虚拟机规范给了实现者充分的自由来实现数组，下面就动手吧！</p> <h4 id="_8-2-数组实现"><a href="#_8-2-数组实现" class="header-anchor">#</a> 8.2 数组实现</h4> <p>将在类和对象的基础上实现数组类和数组对象，先来看数组对象。</p> <h5 id="_8-2-1-数组对象"><a href="#_8-2-1-数组对象" class="header-anchor">#</a> 8.2.1 数组对象</h5> <p>和普通对象一样，数组也是分配在堆中的，通过引用来使用。所以需要改造Object结构体，让它既可以表示普通的对象，也可以表示数组。打开ch08\rtda\heap\object.go，修改Object结构体，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Object <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    class <span class="token operator">*</span>Class 
    data <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>把fields字段改为data，类型也从Slots变成了interface{}。Go语言的interface{}类型很像C语言中的void*，该类型的变量可以容纳任何类型的值。对于普通对象来说，data字段中存放的仍然还是Slots变量。但是对于数组，可以在其中放各种类型的数组，详见下文。newObject（）用来创建普通对象，因此需要做相应的调整，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newObject</span><span class="token punctuation">(</span>class <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span> 
        class<span class="token punctuation">:</span> class<span class="token punctuation">,</span> 
        data<span class="token punctuation">:</span> <span class="token function">newSlots</span><span class="token punctuation">(</span>class<span class="token punctuation">.</span>instanceSlotCount<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>因为Fields（）方法也仍然只针对普通对象，所以它的代码也需要做相应调整，如下所示：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Slots <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span>Slots<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>需要给Object结构体添加几个数组特有的方法，为了让代码更加清晰，在单独的文件中定义这些方法。在ch08/rtda/heap目录下创建array_object.go文件，在其中实现8个方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> heap 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int8</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int8</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Shorts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int16</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int16</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Longs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Floats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float32</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float32</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Doubles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Refs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object <span class="token punctuation">{</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre></div><p>上面这8个方法分别针对引用类型数组和7种基本类型数组返回具体的数组数据。继续编辑array_object.go文件，在其中添加ArrayLength（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">ArrayLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int32</span> <span class="token punctuation">{</span> 
    <span class="token keyword">switch</span> self<span class="token punctuation">.</span>fields<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int8</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int16</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float32</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Not array!&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>读者也许会好奇，为什么返回数组数据的方法有8个，但却只有一个统一的ArrayLength（）方法呢？答案是，这些方法主要是供<code>&lt;t&gt;aload</code>、<code>&lt;t&gt;astore</code>和arraylength指令使用的。<code>&lt;t&gt;aload</code>和<code>&lt;t&gt;astore</code>系列指令各有8条，所以针对每种类型都提供一个方法，返回相应的数组数据。因为arraylength指令只有一条，所以ArrayLength（）方法需要自己判断数组类型。</p> <p>那么为什么没有实现Booleans（）方法呢？因为将使用[]int8来表示布尔数组，所以只需要Bytes（）方法即可。心急的读者可以先跳到8.3小节，看看数组相关指令是如何实现的。下面实现数组类。</p> <h5 id="_8-2-2-数组类"><a href="#_8-2-2-数组类" class="header-anchor">#</a> 8.2.2 数组类</h5> <p>不需要修改Class结构体，只给它添加几个数组特有的方法即可。为了强调这些方法只针对数组类，同时也避免class.go文件变得过长，把这些方法定义在新的文件中。</p> <p>在ch08/rtda/heap目录下创建array_class.go文件，在其中定义NewArray（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">NewArray</span><span class="token punctuation">(</span>count <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">IsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Not array class: &quot;</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">switch</span> self<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;[Z&quot;</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>self<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int8</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">}</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;[B&quot;</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>self<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int8</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">}</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;[C&quot;</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>self<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">}</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;[S&quot;</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>self<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int16</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">}</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;[I&quot;</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>self<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">}</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;[J&quot;</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>self<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">}</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;[F&quot;</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>self<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float32</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">}</span> 
        <span class="token keyword">case</span> <span class="token string">&quot;[D&quot;</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>self<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">}</span> 
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>self<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>NewArray（）方法专门用来创建数组对象。如果类并不是数组类，就调用panic（）函数终止程序执行，否则根据数组类型创建数组对象。注意：布尔数组是使用字节数组来表示的。继续编辑array_class.go，在其中定义IsArray（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">IsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'['</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>还会在array_class.go文件中实现其他几个方法，等用到时再介绍。下面修改类加载器，让它可以加载数组类。</p> <h5 id="_8-2-3-加载数组类"><a href="#_8-2-3-加载数组类" class="header-anchor">#</a> 8.2.3 加载数组类</h5> <p>打开ch08\rtda\heap\class_loader.go文件，修改LoadClass（）方法，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ClassLoader<span class="token punctuation">)</span> <span class="token function">LoadClass</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Class <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> class<span class="token punctuation">,</span> ok <span class="token operator">:=</span> self<span class="token punctuation">.</span>classMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> class <span class="token comment">// 已经加载 </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'['</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">loadArrayClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">loadNonArrayClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>这里增加了类型判断，如果要加载的类是数组类，则调用新的loadArrayClass（）方法，否则还按照原来的逻辑。loadArrayClass（）方法需要生成一个Class结构体实例，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ClassLoader<span class="token punctuation">)</span> <span class="token function">loadArrayClass</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Class <span class="token punctuation">{</span> 
    class <span class="token operator">:=</span> <span class="token operator">&amp;</span>Class<span class="token punctuation">{</span> 
        accessFlags<span class="token punctuation">:</span> ACC_PUBLIC<span class="token punctuation">,</span> <span class="token comment">// todo </span>
        name<span class="token punctuation">:</span> name<span class="token punctuation">,</span> 
        loader<span class="token punctuation">:</span> self<span class="token punctuation">,</span> 
        initStarted<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
        superClass<span class="token punctuation">:</span> self<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        interfaces<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Class<span class="token punctuation">{</span> 
            self<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Cloneable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            self<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/io/Serializable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span>
    self<span class="token punctuation">.</span>classMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> class 
    <span class="token keyword">return</span> class 
<span class="token punctuation">}</span>
</code></pre></div><p>前面三个字段的值比较好理解，不多解释。因为数组类不需要初始化，所以把initStarted字段设置成true。数组类的超类是java.lang.Object，并且实现了java.lang. -Cloneable和java.io.Serializable接口。类加载器改造完毕，下面来实现数组相关指令。</p> <h4 id="_8-3-数组相关指令"><a href="#_8-3-数组相关指令" class="header-anchor">#</a> 8.3 数组相关指令</h4> <p>本节要实现20条指令，其中newarray、anewarray、 multianewarray和arraylength指令属于引用类指令；<code>&lt;t&gt;aload</code>和<code>&lt;t&gt;astore</code>系列指令各有8条，分别属于加载类和存储类指令。下面的Java程序演示了部分数组相关指令的用处。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// newarray </span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// anewarray </span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// multianewarray </span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> a1<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// arraylength </span>
        a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// iastore </span>
        <span class="token keyword">int</span> y <span class="token operator">=</span> a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// iaload </span>
        a2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span> <span class="token comment">// aastore </span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> a2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// aaload </span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>下面从newarray指令开始。</p> <h5 id="_8-3-1-newarray指令"><a href="#_8-3-1-newarray指令" class="header-anchor">#</a> 8.3.1 newarray指令</h5> <p>newarray指令用来创建基本类型数组，包括boolean[]、byte[]、char[]、short[]、int[]、long[]、float[]和double[]8种。</p> <p>在ch08\instructions\references目录下创建newarray.go，在其中定义newarray指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> references 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda/heap&quot;</span> 
<span class="token keyword">const</span> <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token comment">// atype常量 </span>
<span class="token comment">// Create new array of primitive </span>
<span class="token keyword">type</span> NEW_ARRAY <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    atype <span class="token builtin">uint8</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>newarray指令需要两个操作数。第一个操作数是一个uint8整数，在字节码中紧跟在指令操作码后面，表示要创建哪种类型的数组。Java虚拟机规范把这个操作数叫作atype，并且规定了它的有效值。把这些值定义为常量，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span> 
    AT_BOOLEAN <span class="token operator">=</span> <span class="token number">4</span> 
    AT_CHAR <span class="token operator">=</span> <span class="token number">5</span> 
    AT_FLOAT <span class="token operator">=</span> <span class="token number">6</span> 
    AT_DOUBLE <span class="token operator">=</span> <span class="token number">7</span> 
    AT_BYTE <span class="token operator">=</span> <span class="token number">8</span> 
    AT_SHORT <span class="token operator">=</span> <span class="token number">9</span>AT_INT <span class="token operator">=</span> <span class="token number">10</span> 
    AT_LONG <span class="token operator">=</span> <span class="token number">11</span> 
<span class="token punctuation">)</span>
</code></pre></div><p>FetchOperands（）方法读取atype的值，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>NEW_ARRAY<span class="token punctuation">)</span> <span class="token function">FetchOperands</span><span class="token punctuation">(</span>reader <span class="token operator">*</span>base<span class="token punctuation">.</span>BytecodeReader<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    self<span class="token punctuation">.</span>atype <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUint8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>newarray指令的第二个操作数是count，从操作数栈中弹出，表示数组长度。Execute()方法根据atype和count创建基本类型数组，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>NEW_ARRAY<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    stack <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    count <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> count <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NegativeArraySizeException&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    classLoader <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    arrClass <span class="token operator">:=</span> <span class="token function">getPrimitiveArrayClass</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> self<span class="token punctuation">.</span>atype<span class="token punctuation">)</span> 
    arr <span class="token operator">:=</span> arrClass<span class="token punctuation">.</span><span class="token function">NewArray</span><span class="token punctuation">(</span><span class="token function">uint</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    stack<span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>如果count小于0，则抛出NegativeArraySizeException异常，否则根据atype值使用当前类的类加载器加载数组类，然后创建数组对象并推入操作数栈。getPrimitiveArray -Class()函数的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">getPrimitiveArrayClass</span><span class="token punctuation">(</span>loader <span class="token operator">*</span>heap<span class="token punctuation">.</span>ClassLoader<span class="token punctuation">,</span> atype <span class="token builtin">uint8</span><span class="token punctuation">)</span> <span class="token operator">*</span>heap<span class="token punctuation">.</span>Class <span class="token punctuation">{</span> 
    <span class="token keyword">switch</span> atype <span class="token punctuation">{</span><span class="token keyword">case</span> AT_BOOLEAN<span class="token punctuation">:</span> <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;[Z&quot;</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> AT_BYTE<span class="token punctuation">:</span> <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;[B&quot;</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> AT_CHAR<span class="token punctuation">:</span> <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;[C&quot;</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> AT_SHORT<span class="token punctuation">:</span> <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;[S&quot;</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> AT_INT<span class="token punctuation">:</span> <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;[I&quot;</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> AT_LONG<span class="token punctuation">:</span> <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;[J&quot;</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> AT_FLOAT<span class="token punctuation">:</span> <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;[F&quot;</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> AT_DOUBLE<span class="token punctuation">:</span> <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;[D&quot;</span><span class="token punctuation">)</span> 
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid atype!&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>下面实现anewarray指令。</p> <h5 id="_8-3-2-anewarray指令"><a href="#_8-3-2-anewarray指令" class="header-anchor">#</a> 8.3.2 anewarray指令</h5> <p>anewarray指令用来创建引用类型数组。在ch08\instructions\references目录下创建anewarray.go文件，在其中定义anewarray指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> references 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda/heap&quot;</span> 
<span class="token comment">// Create new array of reference </span>
<span class="token keyword">type</span> ANEW_ARRAY <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>Index16Instruction <span class="token punctuation">}</span>
</code></pre></div><p>anewarray指令也需要两个操作数。第一个操作数是uint16索引，来自字节码。通过这个索引可以从当前类的运行时常量池中找到一个类符号引用，解析这个符号引用就可以得到数组元素的类。第二个操作数是数组长度，从操作数栈中弹出。Execute（）方法根据数组元素的类型和数组长度创建引用类型数组，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ANEW_ARRAY<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    classRef <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>rtc<span class="token punctuation">.</span>ClassRef<span class="token punctuation">)</span> 
    componentClass <span class="token operator">:=</span> classRef<span class="token punctuation">.</span><span class="token function">ResolvedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    stack <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    count <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> count <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NegativeArraySizeException&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    arrClass <span class="token operator">:=</span> componentClass<span class="token punctuation">.</span><span class="token function">ArrayClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    arr <span class="token operator">:=</span> arrClass<span class="token punctuation">.</span><span class="token function">NewArray</span><span class="token punctuation">(</span><span class="token function">uint</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    stack<span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>上面的代码比较容易理解，这里就不详细解释了。Class结构体的ArrayClass（）方法返回与类对应的数组类，代码在class.go文件中，如下所示：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">ArrayClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Class <span class="token punctuation">{</span> 
    arrayClassName <span class="token operator">:=</span> <span class="token function">getArrayClassName</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span>arrayClassName<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>先根据类名得到数组类名，然后调用类加载器加载数组类即可。在ch08\rtda\heap目录下创建class_name_helper.go文件，在其中实现getArrayClassName（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> heap 
<span class="token keyword">func</span> <span class="token function">getArrayClassName</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token string">&quot;[&quot;</span> <span class="token operator">+</span> <span class="token function">toDescriptor</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>把类名转变成类型描述符，然后在前面加上方括号即可。在class_name_helper.go文件中实现toDescriptor（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">toDescriptor</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> className<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'['</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> className 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> d<span class="token punctuation">,</span> ok <span class="token operator">:=</span> primitiveTypes<span class="token punctuation">[</span>className<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> d 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;L&quot;</span> <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">&quot;;&quot;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>如果是数组类名，描述符就是类名，直接返回即可。如果是基本类型名，返回对应的类型描述符，否则肯定是普通的类名，前面加上方括号，结尾加上分号即可得到类型描述符。primitiveTypes变量也在class_name_helper.go文件中定义，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> primitiveTypes <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span> 
    <span class="token string">&quot;void&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;V&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Z&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;byte&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;short&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;int&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;long&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;J&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;char&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;float&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;double&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;D&quot;</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>除了newarray和anewarray，还有一个multianewarray指令，专门用来创建多维数组。这个指令比较复杂，放到最后实现。下面来看arraylength指令。</p> <h5 id="_8-3-3-arraylength指令"><a href="#_8-3-3-arraylength指令" class="header-anchor">#</a> 8.3.3 arraylength指令</h5> <p>arraylength指令用于获取数组长度。在ch08\instructions\references目录下创建arraylength.go，在其中定义arraylength指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> references 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda&quot;</span> 
<span class="token comment">// Get length of array </span>
<span class="token keyword">type</span> ARRAY_LENGTH <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span>
</code></pre></div><p>arraylength指令只需要一个操作数，即从操作数栈顶弹出的数组引用。Execute（）方法把数组长度推入操作数栈顶，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ARRAY_LENGTH<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    stack <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    arrRef <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">PopRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> arrRef <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NullPointerException&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    arrLen <span class="token operator">:=</span> arrRef<span class="token punctuation">.</span><span class="token function">ArrayLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    stack<span class="token punctuation">.</span><span class="token function">PushInt</span><span class="token punctuation">(</span>arrLen<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>如果数组引用是null，则需要抛出NullPointerException异常，否则取数组长度，推入操作数栈顶即可。下面实现<code>&lt;t&gt;aload</code>和<code>&lt;t&gt;astore</code>系列指令。</p> <h5 id="_8-3-4-t-aload指令"><a href="#_8-3-4-t-aload指令" class="header-anchor">#</a> 8.3.4 <code>&lt;t&gt;aload</code>指令</h5> <p><code>&lt;t&gt;aload</code>系列指令按索引取数组元素值，然后推入操作数栈。在ch08\instructions \loads目录下创建xaload.go文件，在其中定义8条指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> loads 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda/heap&quot;</span> 
<span class="token keyword">type</span> AALOAD <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> BALOAD <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> CALOAD <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> DALOAD <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> FALOAD <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> IALOAD <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> LALOAD <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> SALOAD <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span>
</code></pre></div><p>这8条指令的实现大同小异，为了节约篇幅，以aaload指令为例进行说明。其Execute（）方法如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>AALOAD<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    stack <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    index <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    arrRef <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">PopRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token function">checkNotNil</span><span class="token punctuation">(</span>arrRef<span class="token punctuation">)</span> 
    refs <span class="token operator">:=</span> arrRef<span class="token punctuation">.</span><span class="token function">Refs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token function">checkIndex</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>refs<span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span> 
    stack<span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>refs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>首先从操作数栈中弹出第一个操作数：数组索引，然后弹出第二个操作数：数组引用。如果数组引用是null，则抛出NullPointerException异常。这个判断在checkNotNil（）函数中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">checkNotNil</span><span class="token punctuation">(</span>ref <span class="token operator">*</span>heap<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> ref <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NullPointerException&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>如果数组索引小于0，或者大于等于数组长度，则抛出ArrayIndexOutOfBoundsExcep
-tion。这个检查在checkIndex（）函数中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">checkIndex</span><span class="token punctuation">(</span>arrLen <span class="token builtin">int</span><span class="token punctuation">,</span> index <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> index <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> index <span class="token operator">&gt;=</span> <span class="token function">int32</span><span class="token punctuation">(</span>arrLen<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;ArrayIndexOutOfBoundsException&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>如果一切正常，则按索引取出数组元素，推入操作数栈顶。</p> <h5 id="_8-3-5-t-astore指令"><a href="#_8-3-5-t-astore指令" class="header-anchor">#</a> 8.3.5 <code>&lt;t&gt;astore</code>指令</h5> <p><code>&lt;t&gt;astore</code>系列指令按索引给数组元素赋值。在ch08\instructions\stores目录下创建xastore.go文件，在其中定义8条指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> stores 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda/heap&quot;</span> 
<span class="token keyword">type</span> AASTORE <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> BASTORE <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> CASTORE <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> DASTORE <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> FASTORE <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> IASTORE <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> LASTORE <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
<span class="token keyword">type</span> SASTORE <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span>
</code></pre></div><p>这8条指令的实现是大同小异，以iastore为例进行说明，其Execute（）方法如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>IASTORE<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    stack <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    val <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    index <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    arrRef <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">PopRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token function">checkNotNil</span><span class="token punctuation">(</span>arrRef<span class="token punctuation">)</span> 
    ints <span class="token operator">:=</span> arrRef<span class="token punctuation">.</span><span class="token function">Ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token function">checkIndex</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ints<span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span> 
    ints<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">int32</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>iastore指令的三个操作数分别是：要赋给数组元素的值、数组索引、数组引用，依次从操作数栈中弹出。如果数组引用是null，则抛出NullPointerException。如果数组索引小于0或者大于等于数组长度，则抛出ArrayIndexOutOfBoundsException异常。这两个检查和<code>&lt;t&gt;aload</code>系列指令一样。如果一切正常，则按索引给数组元素赋值。<code>&lt;t&gt;aload</code>和<code>&lt;t&gt;astore</code>指令实现好了，下面来看multianewarray指令。</p> <h5 id="_8-3-6-multianewarray指令"><a href="#_8-3-6-multianewarray指令" class="header-anchor">#</a> 8.3.6 multianewarray指令</h5> <p>multianewarray指令创建多维数组。在ch08\instructions\references目录下创建multianewarray.go文件，在其中定义multianewarray指令，代码如下所示：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> references 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda/heap&quot;</span> 
<span class="token comment">// Create new multidimensional array </span>
<span class="token keyword">type</span> MULTI_ANEW_ARRAY <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    index <span class="token builtin">uint16</span> 
    dimensions <span class="token builtin">uint8</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>multianewarray指令的第一个操作数是个uint16索引，通过这个索引可以从运行时常量池中找到一个类符号引用，解析这个引用就可以得到多维数组类。第二个操作数是个uint8整数，表示数组维度。这两个操作数在字节码中紧跟在指令操作码后面，由Fetch -Operands（）方法读取，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>MULTI_ANEW_ARRAY<span class="token punctuation">)</span> <span class="token function">FetchOperands</span><span class="token punctuation">(</span>reader <span class="token operator">*</span>base<span class="token punctuation">.</span>BytecodeReader<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    self<span class="token punctuation">.</span>index <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUint16</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    self<span class="token punctuation">.</span>dimensions <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUint8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>multianewarray指令还需要从操作数栈中弹出n个整数，分别代表每一个维度的数组长度。Execute（）方法根据数组类、数组维度和各个维度的数组长度创建多维数组，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>MULTI_ANEW_ARRAY<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    classRef <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span><span class="token function">uint</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">.</span>ClassRef<span class="token punctuation">)</span> 
    arrClass <span class="token operator">:=</span> classRef<span class="token punctuation">.</span><span class="token function">ResolvedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    stack <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    counts <span class="token operator">:=</span> <span class="token function">popAndCheckCounts</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>dimensions<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    arr <span class="token operator">:=</span> <span class="token function">newMultiDimensionalArray</span><span class="token punctuation">(</span>counts<span class="token punctuation">,</span> arrClass<span class="token punctuation">)</span> 
    stack<span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>这里提醒读者注意，在anewarray指令中，解析类符号引用后得到的是数组元素的类，而这里解析出来的直接就是数组类。
popAndCheckCounts（）函数从操作数栈中弹出n个int值，并且确保它们都大于等于0。如果其中任何一个小于0，则抛出NegativeArraySizeException异常。代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">popAndCheckCounts</span><span class="token punctuation">(</span>stack <span class="token operator">*</span>rtda<span class="token punctuation">.</span>OperandStack<span class="token punctuation">,</span> dimensions <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span> <span class="token punctuation">{</span> 
    counts <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">)</span> 
    <span class="token keyword">for</span> i <span class="token operator">:=</span> dimensions <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span> 
        counts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">PopInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token keyword">if</span> counts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span> 
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NegativeArraySizeException&quot;</span><span class="token punctuation">)</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> counts 
<span class="token punctuation">}</span>
</code></pre></div><p>newMultiArray（）函数创建多维数组，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newMultiDimensionalArray</span><span class="token punctuation">(</span>counts <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">,</span> arrClass <span class="token operator">*</span>heap<span class="token punctuation">.</span>Class<span class="token punctuation">)</span> <span class="token operator">*</span>heap<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> 
    count <span class="token operator">:=</span> <span class="token function">uint</span><span class="token punctuation">(</span>counts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
    arr <span class="token operator">:=</span> arrClass<span class="token punctuation">.</span><span class="token function">NewArray</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>counts<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span> 
        refs <span class="token operator">:=</span> arr<span class="token punctuation">.</span><span class="token function">Refs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> refs <span class="token punctuation">{</span> 
            refs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> newMultiDimensionalArray <span class="token punctuation">(</span>counts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 		arrClass<span class="token punctuation">.</span><span class="token function">ComponentClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> arr 
<span class="token punctuation">}</span>
</code></pre></div><p>Class结构体的ComponentClass（）方法返回数组类的元素类型在array_class.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">ComponentClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Class <span class="token punctuation">{</span> 
    componentClassName <span class="token operator">:=</span> <span class="token function">getComponentClassName</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span>componentClassName<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>ComponentClass（）方法先根据数组类名推测出数组元素类名，然后用类加载器加载元素类即可。getComponentClassName（）函数在ch08\rtda\heap\class_name_helper.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">getComponentClassName</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> className<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'['</span> <span class="token punctuation">{</span> 
        componentTypeDescriptor <span class="token operator">:=</span> className<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> 
        <span class="token keyword">return</span> <span class="token function">toClassName</span><span class="token punctuation">(</span>componentTypeDescriptor<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Not array: &quot;</span> <span class="token operator">+</span> className<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>数组类名以方括号开头，把它去掉就是数组元素的类型描述符，然后把类型描述符转成类名即可。toClassName（）函数也在class_name_helper.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">toClassName</span><span class="token punctuation">(</span>descriptor <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> descriptor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'['</span> <span class="token punctuation">{</span> <span class="token comment">// array </span>
        <span class="token keyword">return</span> descriptor 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> descriptor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'L'</span> <span class="token punctuation">{</span> <span class="token comment">// object </span>
        <span class="token keyword">return</span> descriptor<span class="token punctuation">[</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> className<span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> primitiveTypes <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> d <span class="token operator">==</span> descriptor <span class="token punctuation">{</span> <span class="token comment">// primitive </span>
            <span class="token keyword">return</span> className 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid descriptor: &quot;</span> <span class="token operator">+</span> descriptor<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>如果类型描述符以方括号开头，那么肯定是数组，描述符即是类名。如果类型描述符以L开头，那么肯定是类描述符，去掉开头的L和末尾的分号即是类名，否则判断是否是基本类型的描述符，如果是，返回基本类型名称，否则调用panic（）函数终止程序执行。
至此，multianewarray终于解释完了。由于该指令比较难理解，用一个例子分析。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>上面的Java方法创建了一个三维数组，编译之后的字节码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token number">00</span> iconst_3 
<span class="token number">01</span> iconst_4 
<span class="token number">02</span> iconst_5 
<span class="token number">03</span> multianewarray #<span class="token number">5</span> <span class="token comment">// [[[I, 3 </span>
<span class="token number">07</span> astore_1 
<span class="token number">08</span> <span class="token keyword">return</span> 
</code></pre></div><p>编译器先生成了三条iconst_n指令，然后又生成了一条multianewarray指令，剩下的两条指令和数组创建无关。multianewarray指令的第一个操作数是5，是个类引用，类名是[[[I，说明要创建的是int[][][]数组。第二个操作数是3，说明要创建三维数组。</p> <p>当方法执行时，三条iconst_n指令先后把整数3、4、5推入操作数栈顶。multianewarray指令在解码时就已经拿到常量池索引（5）和数组维度（3）。在执行时，它先查找运行时常量池索引，知道要创建的是int[][][]数组，接着从操作数栈中弹出三个int值，依次是5、4、3。现在multianewarray指令拿到了全部信息，从最外维开始创建数组实例即可。专门用于数组的指令实现好了，但别忘了还需要修改ch08\instructions\factory.go文件，在其中添加这些指令的case语句。改动比较简单，这里就不给出代码了。下面修改instanceof和checkcast，让这两条指令可以正确用于数组对象。</p> <h5 id="_8-3-7-完善instanceof和checkcast指令"><a href="#_8-3-7-完善instanceof和checkcast指令" class="header-anchor">#</a> 8.3.7 完善instanceof和checkcast指令</h5> <p>虽然说是完善instanceof和checkcast指令，但实际上这两条指令的代码都没有任何变化。需要修改的是ch08\rtda\heap\class_hierarchy.go文件中的isAssignableFrom（）方法，而且改动很大，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>other <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> 
    s<span class="token punctuation">,</span> t <span class="token operator">:=</span> other<span class="token punctuation">,</span> self 
    <span class="token keyword">if</span> s <span class="token operator">==</span> t <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token boolean">true</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">IsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">IsInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">IsInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">IsSubClassOf</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> 
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">IsImplements</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
            <span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">IsInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">isJlObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">isSuperInterfaceOf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">IsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">IsInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">isJlObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">isJlCloneable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> t<span class="token punctuation">.</span><span class="token function">isJioSerializable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
            sc <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">ComponentClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            tc <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">ComponentClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span> sc <span class="token operator">==</span> tc <span class="token operator">||</span> tc<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>注意，粗体部分是原来的代码，其余都是新增代码。由于篇幅限制，就不详细解释这个函数了，请读者阅读Java虚拟机规范的8.6.5节对instanceof和checkcast指令的描述。需要注意的是：</p> <ul><li>·数组可以强制转换成Object类型（因为数组的超类是Object）。</li> <li>·数组可以强制转换成Cloneable和Serializable类型（因为数组实现了这两个接口）。</li> <li>·如果下面两个条件之一成立，类型为[]SC的数组可以强制转换成类型为[]TC的数组：</li> <li>·TC和SC是同一个基本类型。</li> <li>·TC和SC都是引用类型，且SC可以强制转换成TC。</li></ul> <h4 id="_8-4-测试数组"><a href="#_8-4-测试数组" class="header-anchor">#</a> 8.4 测试数组</h4> <p>数组相关的内容差不多都准备好了，下面用经典的冒泡排序算法测试。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch08</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BubbleSortTest</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">24</span> <span class="token punctuation">,</span><span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
        <span class="token function">bubbleSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">printArray</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bubbleSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">boolean</span> swapped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token keyword">int</span> tmp<span class="token punctuation">;</span> 
        <span class="token keyword">while</span> <span class="token punctuation">(</span>swapped<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            swapped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
            j<span class="token operator">++</span><span class="token punctuation">;</span> 
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> j<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> arr<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                    tmp <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
                    arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
                    arr<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span> 
                    swapped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
                <span class="token punctuation">}</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printArray</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">:</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>打开命令行窗口，执行下面的命令编译本章代码：</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>go <span class="token function">install</span> jvmgo<span class="token punctuation">\</span>ch08
</code></pre></div><p>命令执行完毕后，在D：\go\workspace\bin目录下出现ch08.exe文件。用javac编译，然后用ch08.exe执行BubbleSortTest类，结果如图8-1所示。
<img src="/jvmgo-doc/assets/img/8-1.5145690c.png" alt="8-1"><br>
图8-1 BubbleSortTest程序执行结果</p> <h4 id="_8-5-字符串"><a href="#_8-5-字符串" class="header-anchor">#</a> 8.5 字符串</h4> <p>在class文件中，字符串是以MUTF8格式保存的，这一点在3.3.7节讨论过。在Java虚拟机运行期间，字符串以java.lang.String（后面简称String）对象的形式存在，而在String对象内部，字符串又是以UTF16格式保存的。字符串相关功能大部分都是由String（和StringBuilder等）类提供的，本节只实现一些辅助功能即可。</p> <p>String类有两个实例变量。其中一个是value，类型是字符数组，用于存放UTF16编码后的字符序列。另一个是hash，缓存计字符串的哈希码，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">;</span> 
public final class String 
implements java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">,</span> Comparable<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> CharSequence <span class="token punctuation">{</span> 
    <span class="token comment">/** The value is used for character storage. */</span> 
    private final char value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token comment">/** Cache the hash code for the string */</span> 
    private <span class="token builtin">int</span> hash<span class="token punctuation">;</span> <span class="token comment">// Default to 0 </span>
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>字符串对象是不可变（immutable）的，一旦构造好之后，就无法再改变其状态（这里指value字段）。String类有很多构造函数，其中一个是根据字符数组来创建String实例，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>本节将参考上面的构造函数，直接创建String实例。为了节约内存，Java虚拟机内部维护了一个字符串池。String类提供了intern（）实例方法，可以把自己放入字符串池。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>本节将实现字符串池，由于intern（）是本地方法，所以留到第9章实现。</p> <h5 id="_8-5-1-字符串池"><a href="#_8-5-1-字符串池" class="header-anchor">#</a> 8.5.1 字符串池</h5> <p>在ch08\rtda\heap目录下创建string_pool.go文件，在其中定义internedStrings变量，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> heap 
<span class="token keyword">import</span> <span class="token string">&quot;unicode/utf16&quot;</span> 
<span class="token keyword">var</span> internedStrings <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">{</span><span class="token punctuation">}</span> 
用<span class="token keyword">map</span>来表示字符串池，key是Go字符串，value是Java字符串。继续编辑string_po <span class="token operator">-</span>ol<span class="token punctuation">.</span><span class="token keyword">go</span>文件，在其中实现JString（）函数，代码如下：
<span class="token string">``</span>`<span class="token keyword">go</span>
<span class="token keyword">func</span> <span class="token function">JString</span><span class="token punctuation">(</span>loader <span class="token operator">*</span>ClassLoader<span class="token punctuation">,</span> goStr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> internedStr<span class="token punctuation">,</span> ok <span class="token operator">:=</span> internedStrings<span class="token punctuation">[</span>goStr<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> internedStr 
    <span class="token punctuation">}</span>
    chars <span class="token operator">:=</span> <span class="token function">stringToUtf16</span><span class="token punctuation">(</span>goStr<span class="token punctuation">)</span> 
    jChars <span class="token operator">:=</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span>loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;[C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> chars<span class="token punctuation">}</span> 
    jStr <span class="token operator">:=</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NewObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    jStr<span class="token punctuation">.</span><span class="token function">SetRefVar</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[C&quot;</span><span class="token punctuation">,</span> jChars<span class="token punctuation">)</span> 
    internedStrings<span class="token punctuation">[</span>goStr<span class="token punctuation">]</span> <span class="token operator">=</span> jStr 
    <span class="token keyword">return</span> jStr 
<span class="token punctuation">}</span>
</code></pre></div><p>JString（）函数根据Go字符串返回相应的Java字符串实例。如果Java字符串已经在池中，直接返回即可，否则先把Go字符串（UTF8格式）转换成Java字符数组（UTF16格式），然后创建一个Java字符串实例，把它的value变量设置成刚刚转换而来的字符数组，最后把Java字符串放入池中。注意，这里其实是跳过了String的构造函数，直接用hack的方式创建实例。在前面分析过String类的代码，这样做虽然有点投机取巧，但确实是没有问题的。
继续编辑string_pool.go文件文件，实现stringToUtf16（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">stringToUtf16</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span> <span class="token punctuation">{</span> 
    runes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// utf32 </span>
    <span class="token keyword">return</span> utf16<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>runes<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Go语言字符串在内存中是UTF8编码的，先把它强制转成UTF32，然后调用utf16包的Encode（）函数编码成UTF16。Object结构体的SetRefVar（）方法直接给对象的引用类型实例变量赋值，代码如下（在object.go文件中）：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">SetRefVar</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> descriptor <span class="token builtin">string</span><span class="token punctuation">,</span> ref <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    field <span class="token operator">:=</span> self<span class="token punctuation">.</span>class<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> 
    slots <span class="token operator">:=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span>Slots<span class="token punctuation">)</span> 
    slots<span class="token punctuation">.</span><span class="token function">SetRef</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>slotId<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Class结构体的getField（）函数根据字段名和描述符查找字段，代码如下（代码在class.go文件中）：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">getField</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> descriptor <span class="token builtin">string</span><span class="token punctuation">,</span> isStatic<span class="token punctuation">)</span> <span class="token operator">*</span>Field <span class="token punctuation">{</span> 
    <span class="token keyword">for</span> c <span class="token operator">:=</span> self<span class="token punctuation">;</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> c <span class="token operator">=</span> c<span class="token punctuation">.</span>superClass <span class="token punctuation">{</span> 
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>fields <span class="token punctuation">{</span> 
            <span class="token keyword">if</span> field<span class="token punctuation">.</span><span class="token function">IsStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> isStatic <span class="token operator">&amp;&amp;</span> field<span class="token punctuation">.</span>name <span class="token operator">==</span> name <span class="token operator">&amp;&amp;</span> field<span class="token punctuation">.</span>descriptor <span class="token operator">==</span> descriptor <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> field 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>字符串池实现好了，下面修改ldc指令和类加载器，让它们支持字符串。</p> <h5 id="_8-5-2-完善ldc指令"><a href="#_8-5-2-完善ldc指令" class="header-anchor">#</a> 8.5.2 完善ldc指令</h5> <p>打开ch08\instructions\constants\ldc.go文件，添加一条import语句，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> constants 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch08/rtda/heap&quot;</span> 

然后修改_ldc（）函数，改动如下：
<span class="token keyword">func</span> <span class="token function">_ldc</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">,</span> index <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    stack <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    class <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    c <span class="token operator">:=</span> class<span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> 
    <span class="token keyword">switch</span> c<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">case</span> <span class="token builtin">int32</span><span class="token punctuation">:</span> stack<span class="token punctuation">.</span><span class="token function">PushInt</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token builtin">float32</span><span class="token punctuation">:</span> stack<span class="token punctuation">.</span><span class="token function">PushFloat</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">float32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span> 
            internedStr <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">JString</span><span class="token punctuation">(</span>class<span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            stack<span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>internedStr<span class="token punctuation">)</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码不变 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果ldc试图从运行时常量池中加载字符串常量，则先通过常量拿到Go字符串，然后把它转成Java字符串实例并把引用推入操作数栈顶。</p> <h5 id="_8-5-3-完善类加载器"><a href="#_8-5-3-完善类加载器" class="header-anchor">#</a> 8.5.3 完善类加载器</h5> <p>打开ch08\rtda\heap\class_loader.go文件，修改initStaticFinalVar函数，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">initStaticFinalVar</span><span class="token punctuation">(</span>class <span class="token operator">*</span>Class<span class="token punctuation">,</span> field <span class="token operator">*</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    vars <span class="token operator">:=</span> class<span class="token punctuation">.</span>staticVars 
    cp <span class="token operator">:=</span> class<span class="token punctuation">.</span>constantPool 
    cpIndex <span class="token operator">:=</span> field<span class="token punctuation">.</span><span class="token function">ConstValueIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    slotId <span class="token operator">:=</span> field<span class="token punctuation">.</span><span class="token function">SlotId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> cpIndex <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span> 
        <span class="token keyword">switch</span> field<span class="token punctuation">.</span><span class="token function">Descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token operator">...</span> <span class="token comment">// 其他 </span>
            <span class="token keyword">case</span>语句不变 
            <span class="token keyword">case</span> <span class="token string">&quot;Ljava/lang/String;&quot;</span><span class="token punctuation">:</span> 
                goStr <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>cpIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> 
                jStr <span class="token operator">:=</span> <span class="token function">JString</span><span class="token punctuation">(</span>class<span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> goStr<span class="token punctuation">)</span> 
                vars<span class="token punctuation">.</span><span class="token function">SetRef</span><span class="token punctuation">(</span>slotId<span class="token punctuation">,</span> jStr<span class="token punctuation">)</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>这里增加了字符串类型静态常量的初始化逻辑，代码比较简单，就不多解释了。至此，字符串相关的工作都做完了，下面进行测试。</p> <h4 id="_8-6-测试字符串"><a href="#_8-6-测试字符串" class="header-anchor">#</a> 8.6 测试字符串</h4> <p>打开ch08\main.go文件，修改startJVM（）函数。改动非常小，只是在调用interpret（）函数时，把传递给Java主方法的参数传递给它，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">startJVM</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>Cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码不变 </span>
    <span class="token keyword">if</span> mainMethod <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">interpret</span><span class="token punctuation">(</span>mainMethod<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>verboseInstFlag<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>args<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Main method not found in class %s\n&quot;</span><span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>class<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>打开interpreter.go文件，修改interpret（）函数，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">interpret</span><span class="token punctuation">(</span>method <span class="token operator">*</span>heap<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> logInst <span class="token builtin">bool</span><span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    thread <span class="token operator">:=</span> rtda<span class="token punctuation">.</span><span class="token function">NewThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    frame <span class="token operator">:=</span> thread<span class="token punctuation">.</span><span class="token function">NewFrame</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> 
    thread<span class="token punctuation">.</span><span class="token function">PushFrame</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span> 
    jArgs <span class="token operator">:=</span> <span class="token function">createArgsArray</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span> 
    frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> jArgs<span class="token punctuation">)</span> 
    <span class="token keyword">defer</span> <span class="token function">catchErr</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span> 
    <span class="token function">loop</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> logInst<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>interpret（）函数接收从startJVM（）函数中传递过来的args参数，然后调用createArgs -Array()函数把它转换成Java字符串数组，最后把这个数组推入操作数栈顶。至此，通过命令行传递给Java程序的参数终于可以派上用场了！createArgsArray（）函数的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">createArgsArray</span><span class="token punctuation">(</span>loader <span class="token operator">*</span>heap<span class="token punctuation">.</span>ClassLoader<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>heap<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> 
    stringClass <span class="token operator">:=</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/String&quot;</span><span class="token punctuation">)</span> 
    argsArr <span class="token operator">:=</span> stringClass<span class="token punctuation">.</span><span class="token function">ArrayClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NewArray</span><span class="token punctuation">(</span><span class="token function">uint</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    jArgs <span class="token operator">:=</span> argsArr<span class="token punctuation">.</span><span class="token function">Refs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">{</span> 
        jArgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> heap<span class="token punctuation">.</span><span class="token function">JString</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> argsArr 
<span class="token punctuation">}</span>
</code></pre></div><p>最后，打开ch08\instructions\references\invokevirtual.go，修改_println（）函数，让它可以打印字符串，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// hack! </span>
<span class="token keyword">func</span> <span class="token function">_println</span><span class="token punctuation">(</span>stack <span class="token operator">*</span>rtda<span class="token punctuation">.</span>OperandStack<span class="token punctuation">,</span> descriptor <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">switch</span> descriptor <span class="token punctuation">{</span> 
        <span class="token operator">...</span> <span class="token comment">// 其他 </span>
        <span class="token keyword">case</span>语句不变 
        <span class="token keyword">case</span> <span class="token string">&quot;(Ljava/lang/String;)V&quot;</span><span class="token punctuation">:</span> 
            jStr <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">PopRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            goStr <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">GoString</span><span class="token punctuation">(</span>jStr<span class="token punctuation">)</span> 
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>goStr<span class="token punctuation">)</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码不变 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>GoString（）函数在string_pool.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">GoString</span><span class="token punctuation">(</span>jStr <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    charArr <span class="token operator">:=</span> jStr<span class="token punctuation">.</span><span class="token function">GetRefVar</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[C&quot;</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token function">utf16ToString</span><span class="token punctuation">(</span>charArr<span class="token punctuation">.</span><span class="token function">Chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>先拿到String对象的value变量值，然后把字符数组转换成Go字符串。Object结构体的GetRefVar（）方法（在object.go文件中）如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">GetRefVar</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> descriptor <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span> 
    field <span class="token operator">:=</span> self<span class="token punctuation">.</span>class<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> 
    slots <span class="token operator">:=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span>Slots<span class="token punctuation">)</span> 
    <span class="token keyword">return</span> slots<span class="token punctuation">.</span><span class="token function">GetRef</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>slotId<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>utf16ToString（）函数在string_pool.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">utf16ToString</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    runes <span class="token operator">:=</span> utf16<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// utf8 </span>
    <span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>runes<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>先把UTF16数据转换成UTF8编码，然后强制转换成Go字符串即可。一切就绪！重新编译本章代码，然后用ch08.exe执行在第1章就已经出现过的HelloWorld程序。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch01</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>久违的“Hello，world！”终于出现在控制台上了，如图8-2所示。
<img src="/jvmgo-doc/assets/img/8-2.5f8f663b.png" alt="8-2"><br>
图8-2 HelloWorld程序执行结果</p> <p>再执行一个稍微复杂一些的程序：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch08</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PrintArgs</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>执行结果如图8-3所示。
<img src="/jvmgo-doc/assets/img/8-3.fd42f032.png" alt="8-3"><br>
图8-3 PrintArgs程序执行结果</p> <h4 id="_8-7-本章小结"><a href="#_8-7-本章小结" class="header-anchor">#</a> 8.7 本章小结</h4> <p>本章实现了数组和字符串，在本章的结尾，终于可以运行HelloWorld程序了。不过美中不足的是，我们并不是通过调用System.out.println（）方法，而是通过hack的方式打印的。请读者不要着急，下一章会讨论本地方法调用，第10章会讨论异常处理。到了第11章，将最终去掉这个hack，让println（）方法真正得以调用！</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/jvmgo-doc/assets/js/app.0e038eb3.js" defer></script><script src="/jvmgo-doc/assets/js/2.9a199717.js" defer></script><script src="/jvmgo-doc/assets/js/10.e6c9c852.js" defer></script>
  </body>
</html>
