<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自己动手写Java虚拟机</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css" as="style"><link rel="preload" href="/jvmgo-doc/assets/js/app.0e038eb3.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/2.9a199717.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/5.92e59ff4.js" as="script"><link rel="prefetch" href="/jvmgo-doc/assets/js/10.e6c9c852.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/11.c614ad39.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/12.f2736902.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/13.6ed656c8.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/14.abed2032.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/15.6c8db65d.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/16.1b00c595.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/17.14678ca3.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/18.a4cd171a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/19.bd53fbb2.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/20.28d8d8b4.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/3.6e9095c9.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/4.2e142e62.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/6.9bd6201a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/7.ab861a63.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/8.12d8c35a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/9.76119271.js">
    <link rel="stylesheet" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="第9章-本地方法调用"><a href="#第9章-本地方法调用" class="header-anchor">#</a> 第9章 本地方法调用</h2> <p>在前面的8章里，我们一直在实现Java虚拟机的基本功能。我们已经知道，要想运行Java程序，除了Java虚拟机之外，还需要Java类库的配合。Java虚拟机和Java类库一起构成了Java运行时环境。Java类库主要用Java语言编写，一些无法用Java语言实现的方法则使用本地语言编写，这些方法叫作本地方法。从本章开始，将陆续实现一些Java类库中的本地方法。</p> <p>OpenJDK类库中的本地方法是用JNI（Java Native Interface） [1]编写的，但是要让虚拟机支持JNI规范还需要做大量的工作。由于本书的主要目的是介绍Java虚拟机的工作原理，为了不陷入JNI规范的细节之中，将使用Go语言来实现这些方法。</p> <p>开始编写代码之前，还是先把目录结构准备好。复制ch08目录，改名为ch09。修改main.go等文件，把import语句中的ch08全都替换成ch09。在ch09目录下创建native子目录，本章新增的go文件主要都在这个目录（和它的子目录）中。现在，目录结构看起来是下面这个样子：</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>D:<span class="token punctuation">\</span>go<span class="token punctuation">\</span>workspace<span class="token punctuation">\</span>src 
<span class="token operator">|</span>-jvmgo 
<span class="token operator">|</span>-ch01 ~ ch08 
<span class="token operator">|</span>-ch09 
<span class="token operator">|</span>-classfile 
<span class="token operator">|</span>-classpath 
<span class="token operator">|</span>-instructions 
<span class="token operator">|</span>-native 
<span class="token operator">|</span>-rtda 
<span class="token operator">|</span>-cmd.go 
<span class="token operator">|</span>-interpreter.go 
<span class="token operator">|</span>-main.go 
</code></pre></div><p>[1]http://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/intro.html</p> <h4 id="_9-1-注册和查找本地方法"><a href="#_9-1-注册和查找本地方法" class="header-anchor">#</a> 9.1 注册和查找本地方法</h4> <p>在开始实现本地方法之前，先实现一个本地方法注册表，用来注册和查找本地方法。在ch09\native目录下创建registry.go，先在其中定义NativeMethod类型和registry变量，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> native 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">type</span> NativeMethod <span class="token keyword">func</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> 
<span class="token keyword">var</span> registry <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>NativeMethod<span class="token punctuation">{</span><span class="token punctuation">}</span> 
</code></pre></div><p>把本地方法定义成一个函数，参数是Frame结构体指针，没有返回值。这个frame参数就是本地方法的工作空间，也就是连接Java虚拟机和Java类库的桥梁，后面会看到它是如何发挥作用的。registry变量是个哈希表，值是具体的本地方法实现。那么键是什么呢？继续编辑registry.go文件，在其中实现Register（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Register</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> methodDescriptor <span class="token builtin">string</span><span class="token punctuation">,</span> method NativeMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    key <span class="token operator">:=</span> className <span class="token operator">+</span> <span class="token string">&quot;~&quot;</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">&quot;~&quot;</span> <span class="token operator">+</span> methodDescriptor 
    registry<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> method 
<span class="token punctuation">}</span>
</code></pre></div><p>类名、方法名和方法描述符加在一起才能唯一确定一个方法，所以把它们的组合作为本地方法注册表的键，Register（）函数把前述三种信息和本地方法实现关联起来。继续编辑registry.go文件，在其中实现FindNativeMethod（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FindNativeMethod</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> methodDescriptor <span class="token builtin">string</span><span class="token punctuation">)</span> NativeMethod <span class="token punctuation">{</span> 
key <span class="token operator">:=</span> className <span class="token operator">+</span> <span class="token string">&quot;~&quot;</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">&quot;~&quot;</span> <span class="token operator">+</span> methodDescriptor 
<span class="token keyword">if</span> method<span class="token punctuation">,</span> ok <span class="token operator">:=</span> registry<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> 
<span class="token keyword">return</span> method 
<span class="token punctuation">}</span>
<span class="token keyword">if</span> methodDescriptor <span class="token operator">==</span> <span class="token string">&quot;()V&quot;</span> <span class="token operator">&amp;&amp;</span> methodName <span class="token operator">==</span> <span class="token string">&quot;registerNatives&quot;</span> <span class="token punctuation">{</span> 
<span class="token keyword">return</span> emptyNativeMethod 
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token boolean">nil</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>FindNativeMethod（）方法根据类名、方法名和方法描述符查找本地方法实现，如果找不到，则返回nil。第7章结尾提到过，jva.lang.Object等类是通过一个叫作registerNatives（）的本地方法来注册其他本地方法的。在本章和后面的章节中，将自己注册所有的本地方法实现。所以像registerNatives（）这样的方法就没有太大的用处。为了避免重复代码，这里统一处理，如果遇到这样的本地方法，就返回一个空的实现，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">emptyNativeMethod</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token comment">// do nothing </span>
<span class="token punctuation">}</span>
</code></pre></div><p>本地方法注册表准备好了，下面介绍如何调用本地方法。</p> <h4 id="_9-2-调用本地方法"><a href="#_9-2-调用本地方法" class="header-anchor">#</a> 9.2 调用本地方法</h4> <p>第7章用一段hack代码来跳过本地方法的执行。现在，终于可以把这段代码删除了！编辑ch09\instructions\base\method_invoke_logic.go，把fmt包的导入语句和Invoke -Method（）函数中的hack代码删除。为了节约篇幅，这里就不给出代码了。
Java虚拟机规范并没有规定如何实现和调用本地方法，这给了我们充分的空间来发挥自己的想象力。读者很快就会看到，我们将利用Java虚拟机栈执行本地方法，所以除了删除上面的InvokeMethod（）函数中的hack代码之外，不用做任何修改。
但是，本地方法并没有字节码，如何利用Java虚拟机栈来执行呢？Java虚拟机规范预留了两条指令，操作码分别是0xFE和0xFF。下面将使用0xFE指令来达到这个目的。打开ch09\rtda\heap\method.go文件，修改newMethods（）函数，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newMethods</span><span class="token punctuation">(</span>class <span class="token operator">*</span>Class<span class="token punctuation">,</span> cfMethods <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>classfile<span class="token punctuation">.</span>MemberInfo<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Method <span class="token punctuation">{</span> 
methods <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Method<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cfMethods<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">for</span> i<span class="token punctuation">,</span> cfMethod <span class="token operator">:=</span> <span class="token keyword">range</span> cfMethods <span class="token punctuation">{</span> 
methods<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newMethod</span><span class="token punctuation">(</span>class<span class="token punctuation">,</span> cfMethod<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token keyword">return</span> methods 
<span class="token punctuation">}</span>
</code></pre></div><p>为了避免newMethods（）函数变得太长，我们抽取出一个newMethod（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newMethod</span><span class="token punctuation">(</span>class <span class="token operator">*</span>Class<span class="token punctuation">,</span> cfMethod <span class="token operator">*</span>classfile<span class="token punctuation">.</span>MemberInfo<span class="token punctuation">)</span> <span class="token operator">*</span>Method <span class="token punctuation">{</span> 
method <span class="token operator">:=</span> <span class="token operator">&amp;</span>Method<span class="token punctuation">{</span><span class="token punctuation">}</span> 
method<span class="token punctuation">.</span>class <span class="token operator">=</span> class 
method<span class="token punctuation">.</span><span class="token function">copyMemberInfo</span><span class="token punctuation">(</span>cfMethod<span class="token punctuation">)</span> 
method<span class="token punctuation">.</span><span class="token function">copyAttributes</span><span class="token punctuation">(</span>cfMethod<span class="token punctuation">)</span> 
md <span class="token operator">:=</span> <span class="token function">parseMethodDescriptor</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span> 
method<span class="token punctuation">.</span><span class="token function">calcArgSlotCount</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span>parameterTypes<span class="token punctuation">)</span> 
<span class="token keyword">if</span> method<span class="token punctuation">.</span><span class="token function">IsNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
method<span class="token punctuation">.</span><span class="token function">injectCodeAttribute</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span>returnType<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token keyword">return</span> method 
<span class="token punctuation">}</span>
</code></pre></div><p>粗体部分需要解释一下：先计算argSlotCount字段，如果是本地
方法，则注入字节码和其他信息。继续编辑method.go文件，添加
injectCodeAttribute（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Method<span class="token punctuation">)</span> <span class="token function">injectCodeAttribute</span><span class="token punctuation">(</span>returnType <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
self<span class="token punctuation">.</span>maxStack <span class="token operator">=</span> <span class="token number">4</span> 
self<span class="token punctuation">.</span>maxLocals <span class="token operator">=</span> self<span class="token punctuation">.</span>argSlotCount 
<span class="token keyword">switch</span> returnType<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token string">'V'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">0xfe</span><span class="token punctuation">,</span> <span class="token number">0xb1</span><span class="token punctuation">}</span> <span class="token comment">// return </span>
<span class="token keyword">case</span> <span class="token string">'D'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">0xfe</span><span class="token punctuation">,</span> <span class="token number">0xaf</span><span class="token punctuation">}</span> <span class="token comment">// dreturn </span>
<span class="token keyword">case</span> <span class="token string">'F'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">0xfe</span><span class="token punctuation">,</span> <span class="token number">0xae</span><span class="token punctuation">}</span> <span class="token comment">// freturn </span>
<span class="token keyword">case</span> <span class="token string">'J'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">0xfe</span><span class="token punctuation">,</span> <span class="token number">0xad</span><span class="token punctuation">}</span> <span class="token comment">// lreturn </span>
<span class="token keyword">case</span> <span class="token string">'L'</span><span class="token punctuation">,</span> <span class="token string">'['</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">0xfe</span><span class="token punctuation">,</span> <span class="token number">0xb0</span><span class="token punctuation">}</span> <span class="token comment">// areturn </span>
<span class="token keyword">default</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token number">0xfe</span><span class="token punctuation">,</span> <span class="token number">0xac</span><span class="token punctuation">}</span> <span class="token comment">// ireturn </span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>本地方法在class文件中没有Code属性，所以需要给maxStack和maxLocals字段赋值。本地方法帧的操作数栈至少要能容纳返回值，为了简化代码，暂时给maxStack字段赋值为4。因为本地方法帧的局部变量表只用来存放参数值，所以把argSlotCount赋给maxLocals字段刚好。至于code字段，也就是本地方法的字节码，第一条指令都是0xFE，第二条指令则根据函数的返回值选择相应的返回指令。
另外，由于把方法描述符的解析挪到了newMethod（）函数中，所以calcArgSlotCount()方法也稍微有些变化（增加了一个参数），变动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Method<span class="token punctuation">)</span> <span class="token function">calcArgSlotCount</span><span class="token punctuation">(</span>paramTypes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> paramType <span class="token operator">:=</span> <span class="token keyword">range</span> paramTypes <span class="token punctuation">{</span> 
<span class="token operator">...</span> <span class="token comment">// 其他代码不变 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面我们来实现0xFE指令。在ch09\instructions目录下创建reserved子目录，然后在该目录下创建invokenative.go文件，在其中定义0xFE（后面称之为invokenative）指令，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> reserved 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span>
<span class="token keyword">type</span> INVOKE_NATIVE <span class="token keyword">struct</span><span class="token punctuation">{</span> base<span class="token punctuation">.</span>NoOperandsInstruction <span class="token punctuation">}</span> 
</code></pre></div><p>这个指令不需要操作数，Execute（）方法的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>INVOKE_NATIVE<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
method <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
className <span class="token operator">:=</span> method<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
methodName <span class="token operator">:=</span> method<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
methodDescriptor <span class="token operator">:=</span> method<span class="token punctuation">.</span><span class="token function">Descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
nativeMethod <span class="token operator">:=</span> native<span class="token punctuation">.</span><span class="token function">FindNativeMethod</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> methodDescriptor<span class="token punctuation">)</span> 
<span class="token keyword">if</span> nativeMethod <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
methodInfo <span class="token operator">:=</span> className <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> methodDescriptor 
<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.UnsatisfiedLinkError: &quot;</span> <span class="token operator">+</span> methodInfo<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token function">nativeMethod</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>根据类名、方法名和方法描述符从本地方法注册表中查找本地方法实现，如果找不到，则抛出UnsatisfiedLinkError异常，否则直接调用本地方法。最后，还需要修改instruction -s\factory.go文件，在其中添加invokenative指令的case语句，这里就不给出代码了。
现在，万事俱备，只欠实现本地方法！接下来，我们将实现Object和String等类的一些本地方法。在后面几章中，还会实现更多的本地方法。</p> <h4 id="_9-3-反射"><a href="#_9-3-反射" class="header-anchor">#</a> 9.3 反射</h4> <p>Java的反射机制十分强大，本节讨论的内容只是冰山一角。</p> <h5 id="_9-3-1-类和对象之间的关系"><a href="#_9-3-1-类和对象之间的关系" class="header-anchor">#</a> 9.3.1 类和对象之间的关系</h5> <p>在Java中，类也表现为普通的对象，它的类是java.lang.Class。听起来有点像鸡生蛋还是蛋生鸡的问题：类也是对象，而对象又是类的实例。那么在Java虚拟机内部，究竟是先有类还是先有对象呢？下面就来一探究竟。
如前所述，Java有强大的反射能力。可以在运行期间获取类的各种信息、存取静态和实例变量、调用方法，等等。要想运用这种能力，获取类对象 [1] 是第一步。在Java语言中，有两种方式可以获得类对象引用：使用类字面值和调用对象的getClass（）方法。下面的Java代码演示了这两种方式。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>在第6章中，通过Object结构体的class字段建立了类和对象之间的单向关系。现在把这个关系补充完整，让它成为双向的。打开ch09\rtda\heap\class.go文件，修改Class结构体，添加jClass字段，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Class <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
<span class="token operator">...</span> <span class="token comment">// 其他字段 </span>
jClass <span class="token operator">*</span>Object <span class="token comment">// java.lang.Class实例 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过jClass字段，每个Class结构体实例都与一个类对象关联。另外需要给jClass字段定义Getter方法，代码比较简单，就不给出了。下面打开ch09\rtda\heap\object.go文件，修改Object结构体，添加extra字段，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Object <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
class <span class="token operator">*</span>Class 
data <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
extra <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>extra字段用来记录Object结构体实例的额外信息。同样给它定义Getter和Setter方法，这里就不给出代码了。这个字段之所以是interface{}类型，是因为它在后面几章还会有其他用途。本章，只用它来记录类对象对应的Class结构体指针。</p> <p>如果读者读到这里感觉有些吃力，请不要怀疑自己的理解能力，一定是笔者表达得不够好。另外，笔者在写这一节时，自己也是犯了很多次迷糊的。为了帮助大家更好地理解类和对象之间的关系，让我们想象这样一个极简化的Java虚拟机运行时状态：方法区中只加载了两个类，java.lang.Object和java.lang.Class；堆中只通过new指令分配了一个对象。此时Java虚拟机的内存状态如图9-1所示。
<img src="/jvmgo-doc/assets/img/9-1.260b9958.png" alt="9-1">
图9-1 类和对象关系图</p> <p>图9-1只画出了Class和Object结构体的必要字段，并且刻意分开了堆和方法区。在方法区中，class1和class2分别是java.lang.Object和java.lang.Class类的数据。在堆中，object1和object2分别是java.lang.Object和java.lang.Class的类对象。object3是单独的java.lang.Object实例。虽然已经简化到了极点，但仍然有8条箭头，希望有密集恐惧症的读者不要被吓倒。
[1] 在本书中，类对象特指java.lang.Class类的实例；对象泛指任何类的实例。</p> <h5 id="_9-3-2-修改类加载器"><a href="#_9-3-2-修改类加载器" class="header-anchor">#</a> 9.3.2 修改类加载器</h5> <p>Class和Object结构体准备好了，接下来修改类加载器，让每一个加载到方法区中的类都有一个类对象与之相关联。打开ch09\rtda\heap\class_loader.go文件，修改NewClassLoader（）函数，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewClassLoader</span><span class="token punctuation">(</span>cp <span class="token operator">*</span>classpath<span class="token punctuation">.</span>Classpath<span class="token punctuation">,</span> verboseFlag <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>ClassLoader <span class="token punctuation">{</span> 
loader <span class="token operator">:=</span> <span class="token operator">&amp;</span>ClassLoader<span class="token punctuation">{</span> 
cp<span class="token punctuation">:</span> cp<span class="token punctuation">,</span> 
verboseFlag<span class="token punctuation">:</span> verboseFlag<span class="token punctuation">,</span> 
classMap<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Class<span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span>
loader<span class="token punctuation">.</span><span class="token function">loadBasicClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">return</span> loader 
<span class="token punctuation">}</span>
</code></pre></div><p>在返回ClassLoader结构体实例之前，先调用loadBasicClasses（）函数。这个函数也要添加到class_loader.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ClassLoader<span class="token punctuation">)</span> <span class="token function">loadBasicClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
jlClassClass <span class="token operator">:=</span> self<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Class&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> class <span class="token operator">:=</span> <span class="token keyword">range</span> self<span class="token punctuation">.</span>classMap <span class="token punctuation">{</span> 
<span class="token keyword">if</span> class<span class="token punctuation">.</span>jClass <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
class<span class="token punctuation">.</span>jClass <span class="token operator">=</span> jlClassClass<span class="token punctuation">.</span><span class="token function">NewObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
class<span class="token punctuation">.</span>jClass<span class="token punctuation">.</span>extra <span class="token operator">=</span> class 
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>loadBasicClasses（）函数先加载java.lang.Class类，这又会触发java.lang.Object等类和接口的加载。然后遍历classMap，给已经加载的每一个类关联类对象。好啦，问题已经解决了一半。下面修改LoadClass（）方法，解决另一半问题。改动较大，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ClassLoader<span class="token punctuation">)</span> <span class="token function">LoadClass</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Class <span class="token punctuation">{</span> 
<span class="token keyword">if</span> class<span class="token punctuation">,</span> ok <span class="token operator">:=</span> self<span class="token punctuation">.</span>classMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> 
<span class="token keyword">return</span> class <span class="token comment">// already loaded </span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> class <span class="token operator">*</span>Class 
<span class="token keyword">if</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'['</span> <span class="token punctuation">{</span> <span class="token comment">// array class </span>
class <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">loadArrayClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
class <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">loadNonArrayClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token keyword">if</span> jlClassClass<span class="token punctuation">,</span> ok <span class="token operator">:=</span> self<span class="token punctuation">.</span>classMap<span class="token punctuation">[</span><span class="token string">&quot;java/lang/Class&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> 
class<span class="token punctuation">.</span>jClass <span class="token operator">=</span> jlClassClass<span class="token punctuation">.</span><span class="token function">NewObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
class<span class="token punctuation">.</span>jClass<span class="token punctuation">.</span>extra <span class="token operator">=</span> class 
<span class="token punctuation">}</span>
<span class="token keyword">return</span> class 
<span class="token punctuation">}</span>
</code></pre></div><p>主要的变动是粗体部分。在类加载完之后，看java.lang.Class是否已经加载。如果是，则给类关联类对象。这样，在loadBasicClasses（）和LoadClass（）方法的配合之下，所有加载到方法区的类都设置好了jClass字段。</p> <h5 id="_9-3-3-基本类型的类"><a href="#_9-3-3-基本类型的类" class="header-anchor">#</a> 9.3.3 基本类型的类</h5> <p>void和基本类型也有对应的类对象，但只能通过字面值来访问，如下面的Java代码所示。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>和数组类一样，基本类型的类也是由Java虚拟机在运行期间生成的。继续编辑class_loader.go文件，修改NewClassLoader（）函数，在其中添加如下一行代码：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewClassLoader</span><span class="token punctuation">(</span>cp <span class="token operator">*</span>classpath<span class="token punctuation">.</span>Classpath<span class="token punctuation">,</span> verboseFlag <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>ClassLoader <span class="token punctuation">{</span> 
<span class="token operator">...</span> <span class="token comment">// 前面的代码不变 </span>
loader<span class="token punctuation">.</span><span class="token function">loadBasicClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
loader<span class="token punctuation">.</span><span class="token function">loadPrimitiveClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">return</span> loader 
<span class="token punctuation">}</span> 
</code></pre></div><p>loadPrimitiveClasses（）方法加载void和基本类型的类，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ClassLoader<span class="token punctuation">)</span> <span class="token function">loadPrimitiveClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">for</span> primitiveType<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> primitiveTypes <span class="token punctuation">{</span> 
self<span class="token punctuation">.</span><span class="token function">loadPrimitiveClass</span><span class="token punctuation">(</span>primitiveType<span class="token punctuation">)</span> <span class="token comment">// primitiveType是 void、int、 float等 </span>
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>生成void和基本类型类的代码在loadPrimitiveClass（）方法中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ClassLoader<span class="token punctuation">)</span> <span class="token function">loadPrimitiveClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
class <span class="token operator">:=</span> <span class="token operator">&amp;</span>Class<span class="token punctuation">{</span> 
accessFlags<span class="token punctuation">:</span> ACC_PUBLIC<span class="token punctuation">,</span> 
name<span class="token punctuation">:</span> className<span class="token punctuation">,</span> 
loader<span class="token punctuation">:</span> self<span class="token punctuation">,</span> 
initStarted<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span>
class<span class="token punctuation">.</span>jClass <span class="token operator">=</span> self<span class="token punctuation">.</span>classMap<span class="token punctuation">[</span><span class="token string">&quot;java/lang/Class&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">NewObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
class<span class="token punctuation">.</span>jClass<span class="token punctuation">.</span>extra <span class="token operator">=</span> class 
self<span class="token punctuation">.</span>classMap<span class="token punctuation">[</span>className<span class="token punctuation">]</span> <span class="token operator">=</span> class 
<span class="token punctuation">}</span>
</code></pre></div><p>这里有三点需要说明。第一，void和基本类型的类名就是void、int、float等。第二，基本类型的类没有超类，也没有实现任何接口。
第三，非基本类型的类对象是通过ldc指令加载到操作数栈中的，将在9.3.4节修改ldc指令，让它支持类对象。而基本类型的类对象，虽然在Java代码中看起来是通过字面量获取的，但是编译之后的指令并不是ldc，而是getstatic。每个基本类型都有一个包装类，包装类中有一个静态常量，叫作TYPE，其中存放的就是基本类型的类。例如java.lang. Integer类，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Integer</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码 </span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> TYPE 
<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">getPrimitiveClass</span><span class="token punctuation">(</span><span class="token string">&quot;int&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码 </span>
<span class="token punctuation">}</span> 
</code></pre></div><p>也就是说，基本类型的类是通过getstatic指令访问相应包装类的TYPE字段加载到操作数栈中的。Class.getPrimitiveClass（）是个本地方法，将在9.3.5节实现它。包装类将在9.7小节详细讨论。</p> <h5 id="_9-3-4-修改ldc指令"><a href="#_9-3-4-修改ldc指令" class="header-anchor">#</a> 9.3.4 修改ldc指令</h5> <p>和基本类型、字符串字面值一样，类对象字面值也是由ldc指令加载的。本节修改ldc指令，让它可以加载类对象。打开ch09\instructions\constants\ldc.go文件，修改_ldc()函数，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">_ldc</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">,</span> index <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
stack <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
class <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
c <span class="token operator">:=</span> class<span class="token punctuation">.</span><span class="token function">ConstantPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetConstant</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> 
<span class="token keyword">switch</span> c<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">case</span> <span class="token builtin">int32</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
<span class="token keyword">case</span> <span class="token builtin">float32</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
<span class="token keyword">case</span> <span class="token operator">*</span>heap<span class="token punctuation">.</span>ClassRef<span class="token punctuation">:</span> 
classRef <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">.</span>ClassRef<span class="token punctuation">)</span> 
classObj <span class="token operator">:=</span> classRef<span class="token punctuation">.</span><span class="token function">ResolvedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">JClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
stack<span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>classObj<span class="token punctuation">)</span> 
<span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>以上只是增加了一个case语句，其他地方没什么变化。如果运行时，常量池中的常量是类引用，则解析类引用，然后把类的类对象推入操作数栈顶。</p> <h5 id="_9-3-5-通过反射获取类名"><a href="#_9-3-5-通过反射获取类名" class="header-anchor">#</a> 9.3.5 通过反射获取类名</h5> <p>为了支持通过反射获取类名，本小节将实现以下4个本地方法：</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>·java.lang.Object.getClass（）
·java.lang.Class.getPrimitiveClass（）
·java.lang.Class.getName0（）
·java.lang.Class.desiredAssertionStatus0（）</p></div> <p>Object.getClass（）就不用多说了，它返回对象的类对象引用。Class.getPrimitiveClass（）在9.3.3节提到过，基本类型的包装类在初始化时会调用这个方法给TPYE字段赋值。Character类是基本类型char的包装类，它在初始化时会调用Class.desiredAssertionStatus0（）方法，所以这个方法也需要实现。最后，之所以要实现getName0（）方法，是因为Class.getName（）方法是依赖这个本地方法工作的，该方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.lang.Class</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token operator">=</span> <span class="token function">getName0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">return</span> name<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>在ch09\native目录下创建java子目录，在java子目录下创建lang子目录，然后在lang目录中创建Object.go文件，在其中注册getClass（）本地方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> lang 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getClass&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()Ljava/lang/Class;&quot;</span><span class="token punctuation">,</span> getClass<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>继续编辑Object.go，实现getClass（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// public final native Class&lt;?&gt; getClass(); </span>
<span class="token keyword">func</span> <span class="token function">getClass</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
this <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
class <span class="token operator">:=</span> this<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">JClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>class<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>这是实现的第一个本地方法，所以有必要详细解释一下。首先，从局部变量表中拿到this引用。GetThis（）方法其实就是调用GetRef（0），不过为了提高代码的可读性，给LocalVars结构体添加了这个方法。有了this引用后，通过Class（）方法拿到它的Class结构体指针，进而又通过JClass（）方法拿到它的类对象。最后，把类对象推入操作数栈顶。这样，只用了3行代码，Object.getClass（）方法就实现好了。
在ch09\native\java\lang目录下创建Class.go文件，在其中注册3个本地方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> lang 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda/heap&quot;</span> 
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getPrimitiveClass&quot;</span><span class="token punctuation">,</span> 
<span class="token string">&quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;</span><span class="token punctuation">,</span> getPrimitiveClass<span class="token punctuation">)</span> 
native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getName0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()Ljava/lang/String;&quot;</span><span class="token punctuation">,</span> getName0<span class="token punctuation">)</span> 
native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;desiredAssertionStatus0&quot;</span><span class="token punctuation">,</span> 
<span class="token string">&quot;(Ljava/lang/Class;)Z&quot;</span><span class="token punctuation">,</span> desiredAssertionStatus0<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>先实现getPrimitiveClass（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// static native Class&lt;?&gt; getPrimitiveClass(String name); </span>
<span class="token keyword">func</span> <span class="token function">getPrimitiveClass</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
nameObj <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
name <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">GoString</span><span class="token punctuation">(</span>nameObj<span class="token punctuation">)</span> 
loader <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
class <span class="token operator">:=</span> loader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">JClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>class<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>getPrimitiveClass（）是静态方法。先从局部变量表中拿到类名，这是个Java字符串，需要把它转成Go字符串。基本类型的类已经加载到了方法区中，直接调用类加载器的Load -Class（）方法获取即可。最后，把类对象引用推入操作数栈顶。下面实现getName0（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// private native String getName0(); </span>
<span class="token keyword">func</span> <span class="token function">getName0</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
this <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
class <span class="token operator">:=</span> this<span class="token punctuation">.</span><span class="token function">Extra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>heap<span class="token punctuation">.</span>Class<span class="token punctuation">)</span> 
name <span class="token operator">:=</span> class<span class="token punctuation">.</span><span class="token function">JavaName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
nameObj <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">JString</span><span class="token punctuation">(</span>class<span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> 
frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>nameObj<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>首先从局部变量表中拿到this引用，这是一个类对象引用，通过Extra（）方法可以获得与之对应的Class结构体指针。然后拿到类名，转成Java字符串并推入操作数栈顶。注意这里需要的是java.lang.Object这样的类名，而非java/lang/Object。Class结构体的JavaName（）方法返回转换后的类名，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">JavaName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
<span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>本书不讨论断言。desiredAssertionStatus0（）方法把false推入操作数栈顶，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// private static native boolean desiredAssertionStatus0(Class&lt;?&gt; clazz);</span>
<span class="token keyword">func</span> <span class="token function">desiredAssertionStatus0</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>4个本地方法都实现好了，而且也已经在init（）函数中注册，那么可以进行测试了吗？还不行，因为init（）函数还没有机会执行。
编辑ch09\instructions\reserved\invokenative.go文件，在其中导入lang包，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> reserved 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span> 
<span class="token keyword">import</span> <span class="token boolean">_</span> <span class="token string">&quot;jvmgo/ch09/native/java/lang&quot;</span> 
</code></pre></div><p>如果没有任何包依赖lang包，它就不会被编译进可执行文件，上面的本地方法也就不会被注册。所以需要一个地方导入lang包，把它放在invokenative.go文件中。由于没有显示使用lang中的变量或函数，所以必须在包名前面加上下划线，否则无法通过编译。这个技术在Go语言中叫作“import for side effect”。 [1]
[1]https://golang.org/doc/effective_go.html#blank_import</p> <h5 id="_9-3-6-测试本节代码"><a href="#_9-3-6-测试本节代码" class="header-anchor">#</a> 9.3.6 测试本节代码</h5> <p>打开命令行窗口，执行下面的命令编译本章代码：</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>go <span class="token function">install</span> jvmgo<span class="token punctuation">\</span>ch09 
</code></pre></div><p>命令执行完毕后，在D：\go\workspace\bin目录下出现ch09.exe文件。用ch09.exe运行下面的Java程序：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch09</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetClassTest</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// void </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// boolean </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// byte </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// char </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// short </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// int </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// long </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// float </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// double </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// java.lang.Object </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [I </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [[I </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Ljava.lang.Object; </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [[Ljava.lang.Object; </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// java.lang.Runnable </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// java.lang.String </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [D </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Ljava.lang.String; </span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>运行结果如图9-2所示。
<img src="/jvmgo-doc/assets/img/9-2.1eff9bdd.png" alt="9-2"><br>
图9-2 GetClassTest程序执行结果</p> <h4 id="_9-4-字符串拼接和string-intern-方法"><a href="#_9-4-字符串拼接和string-intern-方法" class="header-anchor">#</a> 9.4 字符串拼接和String.intern（）方法</h4> <h5 id="_9-4-1-java类库"><a href="#_9-4-1-java类库" class="header-anchor">#</a> 9.4.1 Java类库</h5> <p>在Java语言中，通过加号来拼接字符串。作为优化，javac编辑器会把字符串拼接操作转换成StringBuilder的使用。例如下面这段Java代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> hello <span class="token operator">=</span> <span class="token string">&quot;hello,&quot;</span><span class="token punctuation">;</span> 
<span class="token class-name">String</span> world <span class="token operator">=</span> <span class="token string">&quot;world!&quot;</span><span class="token punctuation">;</span> 
<span class="token class-name">String</span> str <span class="token operator">=</span> hello <span class="token operator">+</span> world<span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>很可能会被javac优化为下面这样：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">tringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;hello,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>为了运行上面的代码，本节将实现以下3个本地方法：</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ul><li>System.arrayCopy（）</li> <li>Float.floatToRawIntBits（）</li> <li>Double.doubleToRawLongBits（）</li></ul></div> <p>这些方法是在哪里使用的呢?StringBuilder.append()方法只是调用了超类的append()方法，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.lang.StringBuilder </span>
<span class="token annotation punctuation">@Override</span> 
<span class="token keyword">public</span> <span class="token class-name">StringBuilder</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用 </span>
<span class="token class-name">AbstractStringBuilder</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>AbstractStringBuilder.append（）方法调用了String.getChars（）方法获取字符数组，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.lang.AbstractStringBuilder </span>
<span class="token keyword">public</span> <span class="token class-name">AbstractStringBuilder</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">appendNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">int</span> len <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">ensureCapacityInternal</span><span class="token punctuation">(</span>count <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> 
str<span class="token punctuation">.</span><span class="token function">getChars</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> value<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> 
count <span class="token operator">+=</span> len<span class="token punctuation">;</span> 
<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>String.getChars（）方法调用了System.arraycopy（）方法拷贝数组，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.lang.String </span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getChars</span><span class="token punctuation">(</span><span class="token keyword">int</span> srcBegin<span class="token punctuation">,</span> <span class="token keyword">int</span> srcEnd<span class="token punctuation">,</span> <span class="token keyword">char</span> dst<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> dstBegin<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码</span>
<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> srcBegin<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> dstBegin<span class="token punctuation">,</span> srcEnd <span class="token operator">-</span> srcBegin<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>StringBuilder.toString（）方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.lang.StringBuilder </span>
<span class="token annotation punctuation">@Override</span> 
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token comment">// Create a copy, don't share the array </span>
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>它调用了String的构造函数，这个构造函数调用了Arrays.copyOfRange（）方法，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.lang.String </span>
<span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码 </span>
<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> offset<span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Arrays.copyOfRange（）调用了Math.min（）方法，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.util.Arrays </span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">copyOfRange</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> original<span class="token punctuation">,</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token keyword">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">int</span> newLength <span class="token operator">=</span> <span class="token keyword">to</span> <span class="token operator">-</span> from<span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span>newLength <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>from <span class="token operator">+</span> <span class="token string">&quot; &gt; &quot;</span> <span class="token operator">+</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> copy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>newLength<span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> from<span class="token punctuation">,</span> copy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>original<span class="token punctuation">.</span>length <span class="token operator">-</span> from<span class="token punctuation">,</span> newLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">return</span> copy<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Math类在初始化时需要调用Float.floatToRawIntBits（）和Double.doubleToRawLong -Bits（）方法，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>lang</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Math</span> <span class="token punctuation">{</span> 
<span class="token comment">// Use raw bit-wise conversions on guaranteed non-NaN arguments. </span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> negativeZeroFloatBits <span class="token operator">=</span> <span class="token class-name">Float</span><span class="token punctuation">.</span><span class="token function">floatToRawIntBits</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> negativeZeroDoubleBits <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">doubleToRawLongBits</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>Java类库介绍完了，下面实现本地方法。</p> <h5 id="_9-4-2-system-arraycopy-方法"><a href="#_9-4-2-system-arraycopy-方法" class="header-anchor">#</a> 9.4.2 System.arraycopy（）方法</h5> <p>在ch09\native\java\lang目录下创建System.go文件，在其中注册arraycopy（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> lang 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda/heap&quot;</span> 
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/System&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;arraycopy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(Ljava/lang/Object;ILjava/lang/Object;II)V&quot;</span><span class="token punctuation">,</span> arraycopy<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>继续编辑System.go，实现arraycopy（）方法。代码稍微有些复杂，先来看第一部分。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// public static native void arraycopy( </span>
<span class="token comment">// Object src, int srcPos, Object dest, int destPos, int length) </span>
<span class="token keyword">func</span> <span class="token function">arraycopy</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
   vars <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
   src <span class="token operator">:=</span> vars<span class="token punctuation">.</span><span class="token function">GetRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
   srcPos <span class="token operator">:=</span> vars<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
   dest <span class="token operator">:=</span> vars<span class="token punctuation">.</span><span class="token function">GetRef</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 
   destPos <span class="token operator">:=</span> vars<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> 
   length <span class="token operator">:=</span> vars<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> 
</code></pre></div><p>先从局部变量表中拿到5个参数。源数组和目标数组都不能是null，否则按照System类的Javadoc应该抛出NullPointerException异常，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> src <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> dest <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.NullPointerException&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>源数组和目标数组必须兼容才能拷贝，否则应该抛出ArrayStoreExceptio异常，代码如下：
ArrayStoreExceptio异常，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">checkArrayCopy</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dest<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.ArrayStoreException&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>checkArrayCopy（）函数的代码稍后给出。接下来检查srcPos、destPos和length参数，如果有问题则抛出IndexOutOfBoundsException异常，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> srcPos <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> destPos <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> length <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> 
    srcPos<span class="token operator">+</span>length <span class="token operator">&gt;</span> src<span class="token punctuation">.</span><span class="token function">ArrayLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
    destPos<span class="token operator">+</span>length <span class="token operator">&gt;</span> dest<span class="token punctuation">.</span><span class="token function">ArrayLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.IndexOutOfBoundsException&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>最后，参数合法，调用ArrayCopy（）函数进行数组拷贝，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code>heap<span class="token punctuation">.</span><span class="token function">ArrayCopy</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> srcPos<span class="token punctuation">,</span> destPos<span class="token punctuation">,</span> length<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>checkArrayCopy（）函数首先确保src和dest都是数组，然后检查数组类型。如果两者都是引用数组，则可以拷贝，否则两者必须是相同类型的基本类型数组，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">checkArrayCopy</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dest <span class="token operator">*</span>heap<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> 
srcClass <span class="token operator">:=</span> src<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
destClass <span class="token operator">:=</span> dest<span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">if</span> <span class="token operator">!</span>srcClass<span class="token punctuation">.</span><span class="token function">IsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>destClass<span class="token punctuation">.</span><span class="token function">IsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">return</span> <span class="token boolean">false</span> 
<span class="token punctuation">}</span>
<span class="token keyword">if</span> srcClass<span class="token punctuation">.</span><span class="token function">ComponentClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
destClass<span class="token punctuation">.</span><span class="token function">ComponentClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">return</span> srcClass <span class="token operator">==</span> destClass 
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token boolean">true</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Class结构体的IsPrimitive（）函数判断类是否是基本类型的类， 代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Class<span class="token punctuation">)</span> <span class="token function">IsPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> 
<span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> primitiveTypes<span class="token punctuation">[</span>self<span class="token punctuation">.</span>name<span class="token punctuation">]</span> 
<span class="token keyword">return</span> ok
<span class="token punctuation">}</span>
</code></pre></div><p>真正的数组拷贝逻辑在ch09\rtda\heap\array_object.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ArrayCopy</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst <span class="token operator">*</span>Object<span class="token punctuation">,</span> srcPos<span class="token punctuation">,</span> dstPos<span class="token punctuation">,</span> length <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">switch</span> src<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">case</span> <span class="token operator">...</span> 
<span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">:</span> 
_src <span class="token operator">:=</span> src<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class="token punctuation">[</span>srcPos <span class="token punctuation">:</span> srcPos<span class="token operator">+</span>length<span class="token punctuation">]</span>_dst <span class="token operator">:=</span> dst<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">)</span><span class="token punctuation">[</span>dstPos <span class="token punctuation">:</span> dstPos<span class="token operator">+</span>length<span class="token punctuation">]</span> 
<span class="token function">copy</span><span class="token punctuation">(</span>_dst<span class="token punctuation">,</span> _src<span class="token punctuation">)</span> 
<span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">:</span> 
_src <span class="token operator">:=</span> src<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">)</span><span class="token punctuation">[</span>srcPos <span class="token punctuation">:</span> srcPos<span class="token operator">+</span>length<span class="token punctuation">]</span> 
_dst <span class="token operator">:=</span> dst<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">)</span><span class="token punctuation">[</span>dstPos <span class="token punctuation">:</span> dstPos<span class="token operator">+</span>length<span class="token punctuation">]</span> 
<span class="token function">copy</span><span class="token punctuation">(</span>_dst<span class="token punctuation">,</span> _src<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>利用Go的内置函数copy（）进行slice拷贝。为了节约篇幅，上面的代码只给出了int数组和对象数组的case语句，其他情况代码大同小异。</p> <h5 id="_9-4-3-float-floattorawintbits-和-double-doubletorawlongbits-方法"><a href="#_9-4-3-float-floattorawintbits-和-double-doubletorawlongbits-方法" class="header-anchor">#</a> 9.4.3 Float.floatToRawIntBits（）和 Double.doubleToRawLongBits（）方法</h5> <p>Float.floatToRawIntBits（）和Double.doubleToRawLongBits（）返回浮点数的编码，这两个方法大同小异，以Float为例进行介绍。在ch09\native\java\lang目录下创建Float.go文件，在其中注册floatToRawIntBits（）本地方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> lang 
<span class="token keyword">import</span> <span class="token string">&quot;math&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Float&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;floatToRawIntBits&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(F)I&quot;</span><span class="token punctuation">,</span> floatToRawIntBits<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Go语言的math包提供了一个类似函数：Float32bits（），正好可以用来实现floatToRaw-IntBits（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// public static native int floatToRawIntBits(float value); </span>
<span class="token keyword">func</span> <span class="token function">floatToRawIntBits</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    value <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
    bits <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Float32bits</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> 
    frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushInt</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span>bits<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_9-4-4-string-intern-方法"><a href="#_9-4-4-string-intern-方法" class="header-anchor">#</a> 9.4.4 String.intern（）方法</h5> <p>第8章讨论字符串时，实现了字符串池，但它只能在虚拟机内部使用。下面实现String类的intern（）方法，让Java类库也可以使用它。在ch09\native\java\lang目录下创建String.go，在其中注册intern（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> lang 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda/heap&quot;</span> 
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/String&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;intern&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()Ljava/lang/String;&quot;</span><span class="token punctuation">,</span> intern<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>继续编辑String.go文件，实现intern（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// public native String intern(); </span>
<span class="token keyword">func</span> <span class="token function">intern</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    this <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    interned <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">InternString</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span> 
    frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>interned<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>如果字符串还没有入池，把它放入并返回该字符串，否则找到已入池字符串并返回。这个逻辑在InternString（）函数中（ch09\rtda\heap\string_pool.go），代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">InternString</span><span class="token punctuation">(</span>jStr <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span> 
    goStr <span class="token operator">:=</span> <span class="token function">GoString</span><span class="token punctuation">(</span>jStr<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> internedStr<span class="token punctuation">,</span> ok <span class="token operator">:=</span> internedStrings<span class="token punctuation">[</span>goStr<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> internedStr 
    <span class="token punctuation">}</span>
    internedStrings<span class="token punctuation">[</span>goStr<span class="token punctuation">]</span> <span class="token operator">=</span> jStr 
    <span class="token keyword">return</span> jStr 
<span class="token punctuation">}</span>
</code></pre></div><p>字符串相关的本地方法都实现好了，下面我们进行测试。</p> <h5 id="_9-4-5-测试本节代码"><a href="#_9-4-5-测试本节代码" class="header-anchor">#</a> 9.4.5 测试本节代码</h5> <p>下面的Java程序对字符串拼接和入池进行了测试。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch09</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;abc1&quot;</span><span class="token punctuation">;</span> 
        <span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">&quot;abc1&quot;</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true </span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
        <span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span> <span class="token operator">+</span> x<span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false </span>
        s3 <span class="token operator">=</span> s3<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true </span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>重新编译本章代码，然后测试StringTest程序，结果如图9-3所示。
<img src="/jvmgo-doc/assets/img/9-3.1091005b.png" alt="9-3"><br>
图9-3 StringTest程序执行结果</p> <h4 id="_9-5-object-hashcode-、equals-和tostring"><a href="#_9-5-object-hashcode-、equals-和tostring" class="header-anchor">#</a> 9.5 Object.hashCode（）、equals（）和toString（）</h4> <p>Object类有3个非常重要的方法：hashCode（）返回对象的哈希码；equals（）用来比较两个对象是否“相同”；toString（）返回对象的字符串表示。hashCode（）是个本地方法，equals（）和toString（）则是用Java写的，它们的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>lang</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Object</span> <span class="token punctuation">{</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码省略 </span>
    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>下面实现hashCode（）方法。打开ch09\native\java\lang\Object.go，导入unsafe包并注册hashCode（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> lang 
<span class="token keyword">import</span> <span class="token string">&quot;unsafe&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getClass&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()Ljava/lang/Class;&quot;</span><span class="token punctuation">,</span> getClass<span class="token punctuation">)</span> 
native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hashCode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()I&quot;</span><span class="token punctuation">,</span> hashCode<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>继续编辑Object.go，实现hashCode（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// public native int hashCode(); </span>
<span class="token keyword">func</span> <span class="token function">hashCode</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    this <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    hash <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushInt</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>把对象引用（Object结构体指针）转换成uintptr类型，然后强制转换成int32推入操作数栈顶。</p> <p>本节只实现这一个本地方法。重新编译本章代码，然后测试下面的Java程序：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch09</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectTest</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">Object</span> obj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">Object</span> obj2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>ObjectTest程序执行结果如图9-4所示。
<img src="/jvmgo-doc/assets/img/9-4.68c96563.png" alt="9-4"><br>
图9-4 ObjectTest程序执行结果</p> <h4 id="_9-6-object-clone"><a href="#_9-6-object-clone" class="header-anchor">#</a> 9.6 Object.clone（）</h4> <p>Object类提供了clone（）方法，用来支持对象克隆。这也是一个本地方法，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.lang.Object </span>
<span class="token keyword">protected</span> <span class="token keyword">native</span> <span class="token class-name">Object</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span><span class="token punctuation">;</span> 
</code></pre></div><p>本节实现这个方法。在ch09\native\java\lang\Object.go文件中注册clone（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>jlObject<span class="token punctuation">,</span> <span class="token string">&quot;getClass&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()Ljava/lang/Class;&quot;</span><span class="token punctuation">,</span> getClass<span class="token punctuation">)</span> 
    native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>jlObject<span class="token punctuation">,</span> <span class="token string">&quot;hashCode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()I&quot;</span><span class="token punctuation">,</span> hashCode<span class="token punctuation">)</span> 
    native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>jlObject<span class="token punctuation">,</span> <span class="token string">&quot;clone&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()Ljava/lang/Object;&quot;</span><span class="token punctuation">,</span> clone<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>

继续编辑Object<span class="token punctuation">.</span><span class="token keyword">go</span>，实现clone（）方法，代码如下：
<span class="token string">``</span><span class="token string">`go
func clone(frame *rtda.Frame) { 
    this := frame.LocalVars().GetThis() 
    cloneable := this.Class().Loader().LoadClass(&quot;java/lang/Cloneable&quot;) 
    if !this.Class().IsImplements(cloneable) { 
        panic(&quot;java.lang.CloneNotSupportedException&quot;) 
    }
    frame.OperandStack().PushRef(this.Clone()) 
} 
如果类没有实现Cloneable接口，则抛出CloneNotSupportedException异常，否则调用Object结构体的Clone（）方法克隆对象，然后把对象副本引用推入操作数栈顶。Clone（）实现稍微有些长，把它放在ch09\rtda\heap\object_clone.go文件中，代码如下：
`</span><span class="token string">``</span><span class="token keyword">go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Object<span class="token punctuation">{</span> 
        class<span class="token punctuation">:</span> self<span class="token punctuation">.</span>class<span class="token punctuation">,</span> 
        data<span class="token punctuation">:</span> self<span class="token punctuation">.</span><span class="token function">cloneData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>数据克隆逻辑在cloneData（）函数中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">cloneData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> 
    <span class="token keyword">switch</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int8</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int16</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int32</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float32</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">:</span> <span class="token operator">...</span> 
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">:</span> 
            elements <span class="token operator">:=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">)</span> 
            elements2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Object<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>elements<span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token function">copy</span><span class="token punctuation">(</span>elements2<span class="token punctuation">,</span> elements<span class="token punctuation">)</span> 
            <span class="token keyword">return</span> elements2 
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token comment">// []Slot </span>
            slots <span class="token operator">:=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span>Slots<span class="token punctuation">)</span> 
            slots2 <span class="token operator">:=</span> <span class="token function">newSlots</span><span class="token punctuation">(</span><span class="token function">uint</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>slots<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token function">copy</span><span class="token punctuation">(</span>slots2<span class="token punctuation">,</span> slots<span class="token punctuation">)</span> 
            <span class="token keyword">return</span> slots2 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>注意，数组也实现了Cloneable接口，所以上面代码中的case语句针对各种数组进行处理。因为代码都大同小异，所以只给出了引用数组的case语句。default语句对普通对象进行克隆。
重新编译本章代码，测试下面的Java程序。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch09</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CloneTest</span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span> 
    <span class="token keyword">private</span> <span class="token keyword">double</span> pi <span class="token operator">=</span> <span class="token number">3.14</span><span class="token punctuation">;</span> 
    <span class="token annotation punctuation">@Override</span> 
    <span class="token keyword">public</span> <span class="token class-name">CloneTest</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">CloneTest</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CloneNotSupportedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">CloneTest</span> obj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CloneTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">CloneTest</span> obj2 <span class="token operator">=</span> obj1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        obj1<span class="token punctuation">.</span>pi <span class="token operator">=</span> <span class="token number">3.1415926</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>CloneTest程序执行结果如图9-5所示。
<img src="/jvmgo-doc/assets/img/9-5.870a760e.png" alt="9-5"><br>
图9-5 CloneTest程序执行结果</p> <h4 id="_9-7-自动装箱和拆箱"><a href="#_9-7-自动装箱和拆箱" class="header-anchor">#</a> 9.7 自动装箱和拆箱</h4> <p>前面讨论过，为了更好地融入Java的对象系统，每种基本类型都有一个包装类与之对应。从Java 5开始，Java语法增加了自动装箱和拆箱（autoboxing/unboxing）能力，可以在必要时把基本类型转换成包装类型或者反之。这个增强完全是由编译器完成的，Java虚拟机没有做任何调整。
以int类型为例，它的包装类是java.lang.Integer。它提供了2个方法来帮助编译器在int变量和Integer对象之间转换：静态方法value（）把int变量包装成Integer对象；实例方法intValue（）返回被包装的int变量。这两个方法的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>lang</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Integer</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码省略 </span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>low <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>high<span class="token punctuation">)</span> 
            <span class="token keyword">return</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>low<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> value<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>由上面的代码可知，Integer.valueOf（）方法并不是每次都创建Integer（）对象，而是维护了一个缓存池IntegerCache。对于比较小（默认是–128~127）的int变量，在IntegerCache初始化时就预先加载到了池中，需要用时直接从池里取即可。IntegerCache是Integer类的内部类，为了便于参考，下面给出它的完整代码。</p> <div class="language-go extra-class"><pre class="language-go"><code>private static class IntegerCache <span class="token punctuation">{</span> 
    static final <span class="token builtin">int</span> low <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">128</span><span class="token punctuation">;</span> 
    static final <span class="token builtin">int</span> high<span class="token punctuation">;</span> 
    static final Integer cache<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    static <span class="token punctuation">{</span> 
        <span class="token builtin">int</span> h <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">// high value may be configured by property </span>
        String integerCacheHighPropValue <span class="token operator">=</span> 
        sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>VM<span class="token punctuation">.</span><span class="token function">getSavedProperty</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Integer.IntegerCache.high&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>integerCacheHighPropValue <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            try <span class="token punctuation">{</span>
                <span class="token builtin">int</span> i <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>integerCacheHighPropValue<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                i <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token comment">// Maximum array size is Integer.MAX_VALUE </span>
                h <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">-</span>low<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> <span class="token function">catch</span><span class="token punctuation">(</span> NumberFormatException nfe<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token comment">// If the property cannot be parsed into an int, ignore it. </span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span>
        high <span class="token operator">=</span> h<span class="token punctuation">;</span> 
        cache <span class="token operator">=</span> <span class="token builtin">new</span> Integer<span class="token punctuation">[</span><span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
        <span class="token builtin">int</span> j <span class="token operator">=</span> low<span class="token punctuation">;</span> 
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token builtin">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> cache<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> 
            cache<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">Integer</span><span class="token punctuation">(</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// range [-128, 127] must be interned (JLS7 5.1.7) </span>
        assert IntegerCache<span class="token punctuation">.</span>high <span class="token operator">&gt;=</span> <span class="token number">127</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    private <span class="token function">IntegerCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
</code></pre></div><p>具体细节就不解释了，需要说明的是IntegerCache在初始化时需要确定缓存池中Inte -ger对象的上限值，为此它调用了sun.misc.VM类的getSavedProperty（）方法。要想让VM正确初始化需要做很多工作，这个工作推迟到第11章进行。这里先用一个hack让VM.get -SavedProperty（）方法返回非null值，以便IntegerCache可以正常初始化。
在ch09\native目录下创建sun\misc子目录，在其中创建VM.go文件，然后在VM.go文件中注册initialize（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> misc 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda/heap&quot;</span> 
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    native<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;sun/misc/VM&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;initialize&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span> initialize<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>initialize（）方法的实现如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// private static native void initialize(); </span>
<span class="token keyword">func</span> <span class="token function">initialize</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    vmClass <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    savedProps <span class="token operator">:=</span> vmClass<span class="token punctuation">.</span><span class="token function">GetRefVar</span><span class="token punctuation">(</span><span class="token string">&quot;savedProps&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Ljava/util/Properties;&quot;</span><span class="token punctuation">)</span> 
    key <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">JString</span><span class="token punctuation">(</span>vmClass<span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span> 
    val <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">JString</span><span class="token punctuation">(</span>vmClass<span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span> 
    frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>savedProps<span class="token punctuation">)</span> 
    frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> 
    frame<span class="token punctuation">.</span><span class="token function">OperandStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PushRef</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> 
    propsClass <span class="token operator">:=</span> vmClass<span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/util/Properties&quot;</span><span class="token punctuation">)</span> 
    setPropMethod <span class="token operator">:=</span> propsClass<span class="token punctuation">.</span><span class="token function">GetInstanceMethod</span><span class="token punctuation">(</span><span class="token string">&quot;setProperty&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/Object;&quot;</span><span class="token punctuation">)</span> 
    base<span class="token punctuation">.</span><span class="token function">InvokeMethod</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> setPropMethod<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>上面的hack代码可能有些不好理解，但翻译成等价的Java代码后只有一句话：</p> <div class="language-go extra-class"><pre class="language-go"><code>private static native void <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    VM<span class="token punctuation">.</span>savedProps<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>最后，需要修改invokenative.go，在其中导入misc包，改动如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> reserved 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch09/native&quot;</span> 
<span class="token keyword">import</span> <span class="token boolean">_</span> <span class="token string">&quot;jvmgo/ch09/native/java/lang&quot;</span> 
<span class="token keyword">import</span> <span class="token boolean">_</span> <span class="token string">&quot;jvmgo/ch09/native/sun/misc&quot;</span> 
</code></pre></div><p>重新编译本章代码，然后测试下面的Java程序：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">jvmgo<span class="token punctuation">.</span>book<span class="token punctuation">.</span>ch09</span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span> 
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BoxTest</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>BoxTest程序的执行结果如图9-6所示。
<img src="/jvmgo-doc/assets/img/9-6.8f8ec859.png" alt="9-6">
图9-6 BoxTest程序执行结果</p> <h4 id="_9-8-本章小结"><a href="#_9-8-本章小结" class="header-anchor">#</a> 9.8 本章小结</h4> <p>本章主要讨论了本地方法调用，以及Java类库中一些最基本的类。前几章基本上都是围绕Java虚拟机本身如何工作而展开讨论。通过本章的学习，读者应该对Java虚拟机和Java类库如何配合工作有了初步的了解。下一章将讨论异常处理。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/jvmgo-doc/assets/js/app.0e038eb3.js" defer></script><script src="/jvmgo-doc/assets/js/2.9a199717.js" defer></script><script src="/jvmgo-doc/assets/js/5.92e59ff4.js" defer></script>
  </body>
</html>
