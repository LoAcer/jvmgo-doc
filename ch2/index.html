<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自己动手写Java虚拟机</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css" as="style"><link rel="preload" href="/jvmgo-doc/assets/js/app.0e038eb3.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/2.9a199717.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/16.1b00c595.js" as="script"><link rel="prefetch" href="/jvmgo-doc/assets/js/10.e6c9c852.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/11.c614ad39.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/12.f2736902.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/13.6ed656c8.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/14.abed2032.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/15.6c8db65d.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/17.14678ca3.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/18.a4cd171a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/19.bd53fbb2.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/20.28d8d8b4.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/3.6e9095c9.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/4.2e142e62.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/5.92e59ff4.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/6.9bd6201a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/7.ab861a63.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/8.12d8c35a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/9.76119271.js">
    <link rel="stylesheet" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第2章-搜索class文件"><a href="#第2章-搜索class文件" class="header-anchor">#</a> 第2章 搜索class文件</h1> <p>第1章介绍了java命令的用法以及它如何启动Java应用程序：首先启动Java虚拟机，然后加载主类，最后调用主类的main（）方法。但是我们知道，即使是最简单的“Hello，World”程序，也是无法独自运行的，该程序的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>加载HelloWorld类之前，首先要加载它的超类，也就是java.lang.Object。在调用main（）方法之前，因为虚拟机需要准备好参数数组，所以需要加载java.lang.String和java.lang.String[]类。把字符串打印到控制台还需要加载java.lang.System类，等等。那么，Java虚拟机从哪里寻找这些类呢？本章将详细讨论这个问题。</p></div> <p>####2.1 类路径
Java虚拟机规范并没有规定虚拟机应该从哪里寻找类，因此不同的虚拟机实现可以采用不同的方法。Oracle的Java虚拟机实现根据类路径（class path）来搜索类。按照搜索的先后顺序，类路径可以分为以下3个部分：</p> <ul><li>启动类路径（bootstrap classpath）</li> <li>扩展类路径（extension classpath）</li> <li>用户类路径（user classpath）</li></ul> <p>启动类路径默认对应jre\lib目录，Java标准库（大部分在rt.jar里）位于该路径。扩展类路径默认对应jre\lib\ext目录，使用Java扩展机制的类位于这个路径。我们自己实现的类，以及第三方类库则位于用户类路径。可以通过-Xbootclasspath选项修改启动类路径，不过通常并不需要这样做，所以这里就不详细介绍了。</p> <p>用户类路径的默认值是当前目录，也就是“.”。可以设置CLASSPATH环境变量来修改用户类路径，但是这样做不够灵活，所以不推荐使用。更好的办法是给java命令传递-classpath（或简写为-cp）选项。-classpath/-cp选项的优先级更高，可以覆盖CLASSPATH环境变量设置。第1章简单介绍过这个选项，这里再详细解释一下。</p> <p>-classpath/-cp选项既可以指定目录，也可以指定JAR文件或者ZIP文件，如下：</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>java -cp path<span class="token punctuation">\</span>to<span class="token punctuation">\</span>classes <span class="token punctuation">..</span>. 
java -cp path<span class="token punctuation">\</span>to<span class="token punctuation">\</span>lib1.jar <span class="token punctuation">..</span>. 
java -cp path<span class="token punctuation">\</span>to<span class="token punctuation">\</span>lib2.zip <span class="token punctuation">..</span>. 
</code></pre></div><p>还可以同时指定多个目录或文件，用分隔符分开即可。分隔符因操作系统而异。在Windows系统下是分号，在类UNIX（包括Linux、Mac OS X等）系统下是冒号。例如在Windows下：</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>java -cp path<span class="token punctuation">\</span>to<span class="token punctuation">\</span>classes<span class="token punctuation">;</span>lib<span class="token punctuation">\</span>a.jar<span class="token punctuation">;</span>lib<span class="token punctuation">\</span>b.jar<span class="token punctuation">;</span>lib<span class="token punctuation">\</span>c.zip <span class="token punctuation">..</span>.
</code></pre></div><p>从Java 6开始，还可以使用通配符（*）指定某个目录下的所有JAR文件，格式如下：</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>java -cp classes<span class="token punctuation">;</span>lib<span class="token punctuation">\</span>* <span class="token punctuation">..</span>.
</code></pre></div><p>####2.2 准备工作</p> <p>从第2章开始，每章的代码都是建立在前一章的基础之上。把ch01目录复制一份，然后改名为ch02。因为本章要创建的源文件都在classpath包中，所以在ch02目录中创建一个classpath子目录。现在目录结构看起来应该是这样：</p> <div class="language-text extra-class"><pre class="language-text"><code>D:\go\workspace\src 
  |-jvmgo 
    |-ch01 
    |-ch02 
      |-classpath 
      |-cmd.go 
      |-main.go 
</code></pre></div><p>我们的Java虚拟机将使用JDK的启动类路径来寻找和加载Java标准库中的类，因此需要某种方式指定jre目录的位置。命令行选项是个不错的选择，所以增加一个非标准选项-Xjre。打开ch02\cmd.go，修改Cmd结构体，添加XjreOption字段，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Cmd <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    helpFlag <span class="token builtin">bool</span> 
    versionFlag <span class="token builtin">bool</span> 
    cpOption <span class="token builtin">string</span> 
    XjreOption <span class="token builtin">string</span> 
    class <span class="token builtin">string</span> 
    args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>parseCmd（）函数也要相应修改，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">parseCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Cmd <span class="token punctuation">{</span> 
    cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>Cmd<span class="token punctuation">{</span><span class="token punctuation">}</span> 
    flag<span class="token punctuation">.</span>Usage <span class="token operator">=</span> printUsage 
    flag<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd<span class="token punctuation">.</span>helpFlag<span class="token punctuation">,</span> <span class="token string">&quot;help&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;print help message&quot;</span><span class="token punctuation">)</span> 
    flag<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd<span class="token punctuation">.</span>helpFlag<span class="token punctuation">,</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;print help message&quot;</span><span class="token punctuation">)</span> 
    flag<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd<span class="token punctuation">.</span>versionFlag<span class="token punctuation">,</span> <span class="token string">&quot;version&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;print version and exit&quot;</span><span class="token punctuation">)</span> 
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd<span class="token punctuation">.</span>cpOption<span class="token punctuation">,</span> <span class="token string">&quot;classpath&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;classpath&quot;</span><span class="token punctuation">)</span> 
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd<span class="token punctuation">.</span>cpOption<span class="token punctuation">,</span> <span class="token string">&quot;cp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;classpath&quot;</span><span class="token punctuation">)</span> 
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmd<span class="token punctuation">.</span>XjreOption<span class="token punctuation">,</span> <span class="token string">&quot;Xjre&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;path to jre&quot;</span><span class="token punctuation">)</span> 
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token operator">...</span> <span class="token comment">//其他代码不变 </span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-3-实现类路径"><a href="#_2-3-实现类路径" class="header-anchor">#</a> 2.3 实现类路径</h4> <p>可以把类路径想象成一个大的整体，它由启动类路径、扩展类路径和用户类路径三个小路径构成。三个小路径又分别由更小的路径构成。是不是很像组合模式（composite pattern）？没错，本节就套用组合模式来设计和实现类路径。</p> <h5 id="_2-3-1-entry接口"><a href="#_2-3-1-entry接口" class="header-anchor">#</a> 2.3.1 Entry接口</h5> <p>先定义一个接口来表示类路径项。在ch02\classpath目录下创建entry.go文件，在其中定义Entry接口，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> classpath 
<span class="token keyword">import</span> <span class="token string">&quot;os&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;strings&quot;</span> 
<span class="token keyword">const</span> pathListSeparator <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>PathListSeparator<span class="token punctuation">)</span> 
<span class="token keyword">type</span> Entry <span class="token keyword">interface</span> <span class="token punctuation">{</span> 
    <span class="token function">readClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> Entry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> 
    <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> 
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">newEntry</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> Entry <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
</code></pre></div><p>常量pathListSeparator是string类型，存放路径分隔符，后面会用到。Entry接口中有两个方法。readClass（）方法负责寻找和加载class文件；String（）方法的作用相当于Java中的toString（），用于返回变量的字符串表示。</p> <p>readClass（）方法的参数是class文件的相对路径，路径之间用斜线（/）分隔，文件名有.class后缀。比如要读取java.lang.Object类，传入的参数应该是java/lang/Object.class。返回值是读取到的字节数据、最终定位到class文件的Entry，以及错误信息。Go的函数或方法允许返回多个值，按照惯例，可以使用最后一个返回值作为错误信息。</p> <p>newEntry（）函数根据参数创建不同类型的Entry实例，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newEntry</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> Entry <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> pathListSeparator<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token function">newCompositeEntry</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token function">newWildcardEntry</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;.jar&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;.JAR&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
        strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;.zip&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;.ZIP&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token function">newZipEntry</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">newDirEntry</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Entry接口有4个实现，分别是DirEntry、ZipEntry、CompositeEntry和WildcardEntry。下面分别介绍每一种实现。</p> <h5 id="_2-3-2-direntry"><a href="#_2-3-2-direntry" class="header-anchor">#</a> 2.3.2 DirEntry</h5> <p>在4种实现中，DirEntry相对简单一些，表示目录形式的类路径。在ch02\classpath目录下创建entry_dir.go文件，在其中定义DirEntry结构体，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> classpath 
<span class="token keyword">import</span> <span class="token string">&quot;io/ioutil&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;path/filepath&quot;</span> 
<span class="token keyword">type</span> DirEntry <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    absDir <span class="token builtin">string</span> 
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">newDirEntry</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>DirEntry <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>DirEntry<span class="token punctuation">)</span> <span class="token function">readClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">,</span> Entry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>DirEntry<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre></div><p>DirEntry只有一个字段，用于存放目录的绝对路径。和Java语言不同，Go结构体不需要显示实现接口，只要方法匹配即可。Go没有专门的构造函数，本书统一使用new开头的函数来创建结构体实例，并把这类函数称为构造函数。newDirEntry（）函数的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newDirEntry</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>DirEntry <span class="token punctuation">{</span> 
    absDir<span class="token punctuation">,</span> err <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>DirEntry<span class="token punctuation">{</span>absDir<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>newDirEntry（）先把参数转换成绝对路径，如果转换过程出现错误，则调用panic（）函数终止程序执行，否则创建DirEntry实例并返回。</p> <p>下面介绍readClass（）方法：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>DirEntry<span class="token punctuation">)</span> <span class="token function">readClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> Entry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    fileName <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>absDir<span class="token punctuation">,</span> className<span class="token punctuation">)</span> 
    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span> 
    <span class="token keyword">return</span> data<span class="token punctuation">,</span> self<span class="token punctuation">,</span> err 
<span class="token punctuation">}</span>
</code></pre></div><p>readClass（）先把目录和class文件名拼成一个完整的路径，然后调用ioutil包提供的ReadFile（）函数读取class文件内容，最后返回。String（）方法很简单，直接返回目录，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>DirEntry<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>absDir 
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2-3-3-zipentry"><a href="#_2-3-3-zipentry" class="header-anchor">#</a> 2.3.3 ZipEntry</h5> <p>ZipEntry表示ZIP或JAR文件形式的类路径。在ch02\classpath目录下创建entry_zip.go文件，在其中定义ZipEntry结构体，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> classpath 
<span class="token keyword">import</span> <span class="token string">&quot;archive/zip&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;errors&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;io/ioutil&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;path/filepath&quot;</span> 
<span class="token keyword">type</span> ZipEntry <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    absPath <span class="token builtin">string</span> 
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">newZipEntry</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>ZipEntry <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ZipEntry<span class="token punctuation">)</span> <span class="token function">readClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> Entry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ZipEntry<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
</code></pre></div><p>absPath字段存放ZIP或JAR文件的绝对路径。构造函数和String（）与DirEntry大同小异，就不多解释了，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newZipEntry</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>ZipEntry <span class="token punctuation">{</span> 
    absPath<span class="token punctuation">,</span> err <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>ZipEntry<span class="token punctuation">{</span>absPath<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ZipEntry<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>absPath 
<span class="token punctuation">}</span>
</code></pre></div><p>下面重点介绍如何从ZIP文件中提取class文件，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>ZipEntry<span class="token punctuation">)</span> <span class="token function">readClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> Entry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    r<span class="token punctuation">,</span> err <span class="token operator">:=</span> zip<span class="token punctuation">.</span><span class="token function">OpenReader</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>absPath<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err 
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> r<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>File <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> f<span class="token punctuation">.</span>Name <span class="token operator">==</span> className <span class="token punctuation">{</span>
            rc<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err 
            <span class="token punctuation">}</span>
            <span class="token keyword">defer</span> rc<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            data<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span> 
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err 
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> data<span class="token punctuation">,</span> self<span class="token punctuation">,</span> <span class="token boolean">nil</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;class not found: &quot;</span> <span class="token operator">+</span> className<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>首先打开ZIP文件，如果这一步出错的话，直接返回。然后遍历ZIP压缩包里的文件，看能否找到class文件。如果能找到，则打开class文件，把内容读取出来，并返回。如果找不到，或者出现其他错误，则返回错误信息。有两处使用了defer语句来确保打开的文件得以关闭。readClass（）方法每次都要打开和关闭ZIP文件，因此效率不是很高。笔者进行了优化，但鉴于篇幅有限，就不展示具体代码了。感兴趣的读者可以阅读ch02\classpath\entry_zip2.go文件。</p> <h5 id="_2-3-4-compositeentry"><a href="#_2-3-4-compositeentry" class="header-anchor">#</a> 2.3.4 CompositeEntry</h5> <p>在ch02\classpath目录下创建entry_composite.go文件，在其中定义CompositeEntry结构体，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> classpath 
<span class="token keyword">import</span> <span class="token string">&quot;errors&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;strings&quot;</span> 
<span class="token keyword">type</span> CompositeEntry <span class="token punctuation">[</span><span class="token punctuation">]</span>Entry 
<span class="token keyword">func</span> <span class="token function">newCompositeEntry</span><span class="token punctuation">(</span>pathList <span class="token builtin">string</span><span class="token punctuation">)</span> CompositeEntry <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self CompositeEntry<span class="token punctuation">)</span> <span class="token function">readClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> Entry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self CompositeEntry<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
</code></pre></div><p>如前所述，CompositeEntry由更小的Entry组成，正好可以表示成[]Entry。在Go语言中，数组属于比较低层的数据结构，很少直接使用。大部分情况下，使用更便利的slice类型。构造函数把参数（路径列表）按分隔符分成小路径，然后把每个小路径都转换成具体的Entry实例，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newCompositeEntry</span><span class="token punctuation">(</span>pathList <span class="token builtin">string</span><span class="token punctuation">)</span> CompositeEntry <span class="token punctuation">{</span> 
    compositeEntry <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Entry<span class="token punctuation">{</span><span class="token punctuation">}</span> 
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> path <span class="token operator">:=</span> <span class="token keyword">range</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathListSeparator<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        entry <span class="token operator">:=</span> <span class="token function">newEntry</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> 
        compositeEntry <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>compositeEntry<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> compositeEntry 
<span class="token punctuation">}</span>
</code></pre></div><p>相信读者已经想到readClass（）方法的代码了：依次调用每一个子路径的readClass（）方法，如果成功读取到class数据，返回数据即可；如果收到错误信息，则继续；如果遍历完所有的子路径还没有找到class文件，则返回错误。readClass（）方法的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self CompositeEntry<span class="token punctuation">)</span> <span class="token function">readClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> Entry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> entry <span class="token operator">:=</span> <span class="token keyword">range</span> self <span class="token punctuation">{</span> 
        data<span class="token punctuation">,</span> from<span class="token punctuation">,</span> err <span class="token operator">:=</span> entry<span class="token punctuation">.</span><span class="token function">readClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> 
        <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> data<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token boolean">nil</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;class not found: &quot;</span> <span class="token operator">+</span> className<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>String（）方法也不复杂。调用每一个子路径的String（）方法，然后把得到的字符串用路径分隔符拼接起来即可，代码如下：</p> <div class="language- extra-class"><pre class="language-text"><code>func (self CompositeEntry) String() string { 
    strs := make([]string, len(self)) 
    for i, entry := range self { 
        strs[i] = entry.String() 
    }
    return strings.Join(strs, pathListSeparator) 
}
</code></pre></div><h5 id="_2-3-5-wildcardentry"><a href="#_2-3-5-wildcardentry" class="header-anchor">#</a> 2.3.5 WildcardEntry</h5> <p>WildcardEntry实际上也是CompositeEntry，所以就不再定义新的类型了。在ch02\classpath目录下创建entry_wildcard.go文件，在其中定义newWildcardEntry（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> classpath 
<span class="token keyword">import</span> <span class="token string">&quot;os&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;path/filepath&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;strings&quot;</span> 
<span class="token keyword">func</span> <span class="token function">newWildcardEntry</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> CompositeEntry <span class="token punctuation">{</span> 
    baseDir <span class="token operator">:=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">// remove * </span>
    compositeEntry <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Entry<span class="token punctuation">{</span><span class="token punctuation">}</span> 
    walkFn <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> info os<span class="token punctuation">.</span>FileInfo<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
    filepath<span class="token punctuation">.</span><span class="token function">Walk</span><span class="token punctuation">(</span>baseDir<span class="token punctuation">,</span> walkFn<span class="token punctuation">)</span> 
    <span class="token keyword">return</span> compositeEntry 
<span class="token punctuation">}</span>
</code></pre></div><p>首先把路径末尾的星号去掉，得到baseDir，然后调用filepath包的Walk（）函数遍历baseDir创建ZipEntry。Walk（）函数的第二个参数也是一个函数，了解函数式编程的读者应该一眼就可以认出这种用法（即函数可作为参数）。walkFn变量的定义如下：</p> <div class="language-go extra-class"><pre class="language-go"><code>walkFn <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> info os<span class="token punctuation">.</span>FileInfo<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> err 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> info<span class="token punctuation">.</span><span class="token function">IsDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> path <span class="token operator">!=</span> baseDir <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> filepath<span class="token punctuation">.</span>SkipDir 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;.jar&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&quot;.JAR&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        jarEntry <span class="token operator">:=</span> <span class="token function">newZipEntry</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> 
        compositeEntry <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>compositeEntry<span class="token punctuation">,</span> jarEntry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>在walkFn中，根据后缀名选出JAR文件，并且返回SkipDir跳过子目录（通配符类路径不能递归匹配子目录下的JAR文件）。</p> <h5 id="_2-3-6-classpath"><a href="#_2-3-6-classpath" class="header-anchor">#</a> 2.3.6 Classpath</h5> <p>Entry接口和4个实现介绍完了，接下来实现Classpath结构体。还是在ch02\classpath目录下创建classpath.go文件，把下面的代码输入进去。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> classpath 
<span class="token keyword">import</span> <span class="token string">&quot;os&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;path/filepath&quot;</span> 
<span class="token keyword">type</span> Classpath <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    bootClasspath Entry 
    extClasspath Entry 
    userClasspath Entry 
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span>jreOption<span class="token punctuation">,</span> cpOption <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Classpath <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Classpath<span class="token punctuation">)</span> <span class="token function">ReadClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> Entry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Classpath<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
</code></pre></div><p>Classpath结构体有三个字段，分别存放三种类路径。Parse（）函数使用-Xjre选项解析启动类路径和扩展类路径，使用-classpath/-cp选项解析用户类路径，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span>jreOption<span class="token punctuation">,</span> cpOption <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Classpath <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> <span class="token operator">&amp;</span>Classpath<span class="token punctuation">{</span><span class="token punctuation">}</span> 
    cp<span class="token punctuation">.</span><span class="token function">parseBootAndExtClasspath</span><span class="token punctuation">(</span>jreOption<span class="token punctuation">)</span> 
    cp<span class="token punctuation">.</span><span class="token function">parseUserClasspath</span><span class="token punctuation">(</span>cpOption<span class="token punctuation">)</span> 
    <span class="token keyword">return</span> cp 
<span class="token punctuation">}</span>
</code></pre></div><p>parseBootAndExtClasspath（）方法的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Classpath<span class="token punctuation">)</span> <span class="token function">parseBootAndExtClasspath</span><span class="token punctuation">(</span>jreOption <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    jreDir <span class="token operator">:=</span> <span class="token function">getJreDir</span><span class="token punctuation">(</span>jreOption<span class="token punctuation">)</span> 
    <span class="token comment">// jre/lib/* </span>
    jreLibPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>jreDir<span class="token punctuation">,</span> <span class="token string">&quot;lib&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span> 
    self<span class="token punctuation">.</span>bootClasspath <span class="token operator">=</span> <span class="token function">newWildcardEntry</span><span class="token punctuation">(</span>jreLibPath<span class="token punctuation">)</span> 
    <span class="token comment">// jre/lib/ext/* </span>
    jreExtPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>jreDir<span class="token punctuation">,</span> <span class="token string">&quot;lib&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ext&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span> 
    self<span class="token punctuation">.</span>extClasspath <span class="token operator">=</span> <span class="token function">newWildcardEntry</span><span class="token punctuation">(</span>jreExtPath<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>优先使用用户输入的-Xjre选项作为jre目录。如果没有输入该选项，则在当前目录下寻找jre目录。如果找不到，尝试使用JAVA_HOME环境变量。getJreDir（）函数的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">getJreDir</span><span class="token punctuation">(</span>jreOption <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> jreOption <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">exists</span><span class="token punctuation">(</span>jreOption<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> jreOption 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">&quot;./jre&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token string">&quot;./jre&quot;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> jh <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;JAVA_HOME&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> jh <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>jh<span class="token punctuation">,</span> <span class="token string">&quot;jre&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Can not find jre folder!&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>exists（）函数用于判断目录是否存在，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">exists</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> <span class="token boolean">false</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>parseUserClasspath（）方法的代码相对简单一些，如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Classpath<span class="token punctuation">)</span> <span class="token function">parseUserClasspath</span><span class="token punctuation">(</span>cpOption <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> cpOption <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span> 
        cpOption <span class="token operator">=</span> <span class="token string">&quot;.&quot;</span> 
    <span class="token punctuation">}</span>
    self<span class="token punctuation">.</span>userClasspath <span class="token operator">=</span> <span class="token function">newEntry</span><span class="token punctuation">(</span>cpOption<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>如果用户没有提供-classpath/-cp选项，则使用当前目录作为用户类路径。ReadClass（）方法依次从启动类路径、扩展类路径和用户类路径中搜索class文件，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Classpath<span class="token punctuation">)</span> <span class="token function">ReadClass</span><span class="token punctuation">(</span>className <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> Entry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    className <span class="token operator">=</span> className <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span> 
    <span class="token keyword">if</span> data<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> err <span class="token operator">:=</span> self<span class="token punctuation">.</span>bootClasspath<span class="token punctuation">.</span><span class="token function">readClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> data<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> err 
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> data<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> err <span class="token operator">:=</span> self<span class="token punctuation">.</span>extClasspath<span class="token punctuation">.</span><span class="token function">readClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> data<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> err 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>userClasspath<span class="token punctuation">.</span><span class="token function">readClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>注意，传递给ReadClass（）方法的类名不包含“.class”后缀。最后，String（）方法返回用户类路径的字符串表示，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>Classpath<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>userClasspath<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>至此，整个类路径都实现了，下面我们来测试一下。</p> <h5 id="_2-4-测试本章代码"><a href="#_2-4-测试本章代码" class="header-anchor">#</a> 2.4 测试本章代码</h5> <p>打开ch02/main.go文件，添加两条import语句，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main 
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;strings&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch02/classpath&quot;</span> 
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token function">startJVM</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>Cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre></div><p>main（）函数不用变，重写startJVM（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">startJVM</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>Cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> classpath<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>XjreOption<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>cpOption<span class="token punctuation">)</span> 
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:%v class:%v args:%v\n&quot;</span><span class="token punctuation">,</span> cp<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>class<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>args<span class="token punctuation">)</span> 
    className <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
    classData<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> cp<span class="token punctuation">.</span><span class="token function">ReadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find or load main class %s\n&quot;</span><span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>class<span class="token punctuation">)</span> 
        <span class="token keyword">return</span> 
        <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;class data:%v\n&quot;</span><span class="token punctuation">,</span> classData<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>startJVM（）先打印出命令行参数，然后读取主类数据，并打印到控制台。虽然还是无法真正启动Java虚拟机，不过相比第1章，已经有了很大的进步。打开命令行窗口，执行下面的命令编译本章代码。</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>go <span class="token function">install</span> jvmgo<span class="token punctuation">\</span>ch02
</code></pre></div><p>编译成功后，在D：\go\workspace\bin目录下出现ch02.exe文件。执行ch02.exe，指定好-Xjre选项和类名，就可以把class文件的内容打印出来。虽然只是一堆看似杂乱无章的数字，但成就感还是会油然而生。笔者的测试结果如图2-1所示。
<img src="/jvmgo-doc/assets/img/2-1.0f24cb28.png" alt="2-1">
图2-1 ch02.exe的测试结果</p> <h4 id="_2-5-本章小结"><a href="#_2-5-本章小结" class="header-anchor">#</a> 2.5 本章小结</h4> <p>本章讨论了Java虚拟机从哪里寻找class文件，对类路径和-classpath命令行选项有了较为深入的了解，并且把抽象的类路径概念转变成了具体的代码。下一章将研究class文件格式，实现class文件解析。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/jvmgo-doc/assets/js/app.0e038eb3.js" defer></script><script src="/jvmgo-doc/assets/js/2.9a199717.js" defer></script><script src="/jvmgo-doc/assets/js/16.1b00c595.js" defer></script>
  </body>
</html>
