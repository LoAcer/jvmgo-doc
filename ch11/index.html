<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自己动手写Java虚拟机</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css" as="style"><link rel="preload" href="/jvmgo-doc/assets/js/app.0e038eb3.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/2.9a199717.js" as="script"><link rel="preload" href="/jvmgo-doc/assets/js/15.6c8db65d.js" as="script"><link rel="prefetch" href="/jvmgo-doc/assets/js/10.e6c9c852.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/11.c614ad39.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/12.f2736902.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/13.6ed656c8.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/14.abed2032.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/16.1b00c595.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/17.14678ca3.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/18.a4cd171a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/19.bd53fbb2.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/20.28d8d8b4.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/3.6e9095c9.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/4.2e142e62.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/5.92e59ff4.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/6.9bd6201a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/7.ab861a63.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/8.12d8c35a.js"><link rel="prefetch" href="/jvmgo-doc/assets/js/9.76119271.js">
    <link rel="stylesheet" href="/jvmgo-doc/assets/css/0.styles.8ee97746.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar no-sidebar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="第11章-结束"><a href="#第11章-结束" class="header-anchor">#</a> 第11章 结束</h2> <p>在第7章讨论了方法调用和返回，在第8章讨论了数组和字符串。经过整整8章的努力之后，“Hello，World！”终于出现在了控制台上。不过比较遗憾的是，由于java.lang.System类还没有被正确初始化，直接调用System.out.println（）方法会导致NullPointerException异常抛出。为此修改了invokevirtual指令，对println（）方法做了特殊处理。本章将弥补这个遗憾，把这个hack从代码中删除，让Java虚拟机可以真正在控制台上打印数字和字符串。</p> <p>本章也是本书的最后一章，在结尾会对全书内容进行简要回顾。开始本章之前，还是先把目录结构准备好。复制ch10目录，改名为ch11。修改main.go等文件，把import语句中的ch10全都替换成ch11。本章对目录结构没有太大的调整。</p> <h4 id="_11-1-system类是如何被初始化的"><a href="#_11-1-system类是如何被初始化的" class="header-anchor">#</a> 11.1 System类是如何被初始化的</h4> <p>大家都知道，System类有3个公开的静态常量：out、err和in。其中out和err用于向标准输出流和标准错误流中写入信息，in用于从标准输入流中读取信息。那么这3个常量是在哪里被赋值的呢？看一下System类的源代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.lang.System </span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">System</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PrintStream</span> out <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PrintStream</span> err <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
    <span class="token comment">/* register the natives via the static initializer. 
    *
    * VM will invoke the initializeSystemClass method to complete 
    * the initialization for this class separated from clinit. 
    * Note that to use properties set by the VM, see the constraints 
    * described in the initializeSystemClass method. 
    */</span> 
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">static</span> <span class="token punctuation">{</span> 
        <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>从注释可知，System类的初始化过程分为两个阶段。第一个阶段由类初始化方法完成，在这个方法中registerNatives（）方法会注册其他本地方法。第二个阶段由VM完成，在这个阶段VM会调用System.initializeSystemClass()方法。那么initializeSystemClass()方法究竟干了些什么呢？这个方法很长，而且有很详细的注释。去掉与本节讨论无关的代码和注释之后，它的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">/**
* Initialize the system class. Called after thread initialization. 
*/</span> 
private static void <span class="token function">initializeSystemClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
    FileInputStream fdIn <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">FileInputStream</span><span class="token punctuation">(</span>FileDescriptor<span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    FileOutputStream fdOut <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>FileDescriptor<span class="token punctuation">.</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    FileOutputStream fdErr <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>FileDescriptor<span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">setIn0</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">BufferedInputStream</span><span class="token punctuation">(</span>fdIn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">setOut0</span><span class="token punctuation">(</span><span class="token function">newPrintStream</span><span class="token punctuation">(</span>fdOut<span class="token punctuation">,</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;sun.stdout.encoding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">setErr0</span><span class="token punctuation">(</span><span class="token function">newPrintStream</span><span class="token punctuation">(</span>fdErr<span class="token punctuation">,</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;sun.stderr.encoding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>可见in、out和err正是在这里设置的。再来看sun.misc.VM类的源代码（VM类属于Oracle私有代码，并没有开源，下面是反编译后的Java代码）：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// sun.misc.VM </span>
<span class="token keyword">public</span> <span class="token keyword">class</span> VM <span class="token punctuation">{</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码 </span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码 </span>
        <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>VM类在初始化时调用了initialize（）方法。虽然initialize（）是本地方法，但是可以推测正是这个方法调用了System.initializeSystemClass（）方法。是否真的是这样笔者就不做考证了，下面修改解释器，让System类可以正确初始化。</p> <h4 id="_11-2-初始化system类"><a href="#_11-2-初始化system类" class="header-anchor">#</a> 11.2 初始化System类</h4> <p>先打开ch11\instructions\references\invokevirtual.go文件，修改invokevirtual指令的Execute（）方法，把其中的hack代码删掉。由于只是删除代码，这里就不做详细说明了。</p> <p>接下来打开ch11\native\sun\misc\VM.go文件，删除heap包的导入语句。原来的initialize（）方法也是用hack方式实现的，需要重写，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// private static native void initialize(); </span>
<span class="token keyword">func</span> <span class="token function">initialize</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    classLoader <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    jlSysClass <span class="token operator">:=</span> classLoader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/System&quot;</span><span class="token punctuation">)</span> 
    initSysClass <span class="token operator">:=</span> jlSysClass<span class="token punctuation">.</span><span class="token function">GetStaticMethod</span><span class="token punctuation">(</span><span class="token string">&quot;initializeSystemClass&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">)</span> 
    base<span class="token punctuation">.</span><span class="token function">InvokeMethod</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> initSysClass<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>新的实现只是调用了System.initializeSystemClass（）方法而已。下面修改解释器，让它在执行主类的main（）方法之前先调用VM.initialize（）方法。为了让代码的可读性更好，将对main.go文件进行比较大的调整。打开ch11\main.go，把下面的代码复制进去：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main 
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    cmd <span class="token operator">:=</span> <span class="token function">parseCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> cmd<span class="token punctuation">.</span>versionFlag <span class="token punctuation">{</span> 
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;version 0.0.1&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>helpFlag <span class="token operator">||</span> cmd<span class="token punctuation">.</span>class <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span> 
        <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        <span class="token function">newJVM</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>主要逻辑都被挪到了（新增加的）ch11\jvm.go文件中，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main 
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;strings&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch11/classpath&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch11/instructions/base&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch11/rtda&quot;</span> 
<span class="token keyword">import</span> <span class="token string">&quot;jvmgo/ch11/rtda/heap&quot;</span> 
<span class="token keyword">type</span> JVM <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
    cmd <span class="token operator">*</span>Cmd 
    classLoader <span class="token operator">*</span>heap<span class="token punctuation">.</span>ClassLoader 
    mainThread <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Thread 
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">newJVM</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>Cmd<span class="token punctuation">)</span> <span class="token operator">*</span>JVM <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>JVM<span class="token punctuation">)</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre></div><p>newJVM（）函数创建JVM结构体实例，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newJVM</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>Cmd<span class="token punctuation">)</span> <span class="token operator">*</span>JVM <span class="token punctuation">{</span> 
    cp <span class="token operator">:=</span> classpath<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>XjreOption<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>cpOption<span class="token punctuation">)</span> 
    classLoader <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">NewClassLoader</span><span class="token punctuation">(</span>cp<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>verboseClassFlag<span class="token punctuation">)</span> 
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>JVM<span class="token punctuation">{</span> 
        cmd<span class="token punctuation">:</span> cmd<span class="token punctuation">,</span> 
        classLoader<span class="token punctuation">:</span> classLoader<span class="token punctuation">,</span> 
        mainThread<span class="token punctuation">:</span> rtda<span class="token punctuation">.</span><span class="token function">NewThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>start（）方法先初始化VM类，然后执行主类的main（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>JVM<span class="token punctuation">)</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    self<span class="token punctuation">.</span><span class="token function">initVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    self<span class="token punctuation">.</span><span class="token function">execMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>initVM（）先加载sun.mis.VM类，然后执行其类初始化方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>JVM<span class="token punctuation">)</span> <span class="token function">initVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    vmClass <span class="token operator">:=</span> self<span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;sun/misc/VM&quot;</span><span class="token punctuation">)</span> 
    base<span class="token punctuation">.</span><span class="token function">InitClass</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>mainThread<span class="token punctuation">,</span> vmClass<span class="token punctuation">)</span> 
    <span class="token function">interpret</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>mainThread<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>verboseInstFlag<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>execMain（）方法先加载主类，然后执行其main（）方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>JVM<span class="token punctuation">)</span> <span class="token function">execMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    className <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
    mainClass <span class="token operator">:=</span> self<span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> 
    mainMethod <span class="token operator">:=</span> mainClass<span class="token punctuation">.</span><span class="token function">GetMainMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> mainMethod <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Main method not found in class %s\n&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>class<span class="token punctuation">)</span> 
        <span class="token keyword">return</span> 
    <span class="token punctuation">}</span>
    argsArr <span class="token operator">:=</span> self<span class="token punctuation">.</span><span class="token function">createArgsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    frame <span class="token operator">:=</span> self<span class="token punctuation">.</span>mainThread<span class="token punctuation">.</span><span class="token function">NewFrame</span><span class="token punctuation">(</span>mainMethod<span class="token punctuation">)</span> 
    frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> argsArr<span class="token punctuation">)</span> <span class="token comment">// 给 main()方法传递 args参数</span>
    self<span class="token punctuation">.</span>mainThread<span class="token punctuation">.</span><span class="token function">PushFrame</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span> 
    <span class="token function">interpret</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>mainThread<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>verboseInstFlag<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>execMain（）方法的前半部分代码是从main.go文件中拷贝过来的，我们已经比较熟悉了。后半部分代码需要解释的一点是：在调用main（）方法之前，需要给它传递args参数，这是通过直接操作局部变量表实现的。createArgsArray（）方法把Go的[]string变量转换成Java的字符串数组，代码是从interpreter.go文件中拷贝过来的，如下所示：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>JVM<span class="token punctuation">)</span> <span class="token function">createArgsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>heap<span class="token punctuation">.</span>Object <span class="token punctuation">{</span> 
    stringClass <span class="token operator">:=</span> self<span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span><span class="token function">LoadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/String&quot;</span><span class="token punctuation">)</span> 
    argsLen <span class="token operator">:=</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    argsArr <span class="token operator">:=</span> stringClass<span class="token punctuation">.</span><span class="token function">ArrayClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NewArray</span><span class="token punctuation">(</span>argsLen<span class="token punctuation">)</span> 
    jArgs <span class="token operator">:=</span> argsArr<span class="token punctuation">.</span><span class="token function">Refs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> self<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span>args <span class="token punctuation">{</span> 
        jArgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> heap<span class="token punctuation">.</span><span class="token function">JString</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>classLoader<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> argsArr 
<span class="token punctuation">}</span>
</code></pre></div><p>jvm.go文件改好了，下面修改interpret（）函数。打开ch11\interpreter.go，删除heap包的导入语句和createArgsArray（）函数，然后修改interpret（）函数，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">interpret</span><span class="token punctuation">(</span>thread <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Thread<span class="token punctuation">,</span> logInst <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">defer</span> <span class="token function">catchErr</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span> 
    <span class="token function">loop</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> logInst<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>修改之后interpret（）函数简单了许多，直接调用loop（）函数进入循环即可。至此，解释器修改完毕。这就是本章要写的全部代码吗?并不是。为了正常执行System.initialize -SystemClass（）以及System.out.println（）等方法，还需要实现很多Java类库中的本地方法。为了节约篇幅，这里就不一一列举了，请读者阅读随书源代码。下面以System.out. println（String）为例解释字符串是如何被打印到控制台的，其他类型变量的打印原理同字符串类似。</p> <h4 id="_11-3-system-out-println-是如何工作的"><a href="#_11-3-system-out-println-是如何工作的" class="header-anchor">#</a> 11.3 System.out.println（）是如何工作的</h4> <p>回到System.initializeSystemClass（）方法，进一步省略之后，其代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// java.lang.System </span>
public final static PrintStream out <span class="token operator">=</span> null<span class="token punctuation">;</span> 
private static void <span class="token function">initializeSystemClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
    FileOutputStream fdOut <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>FileDescriptor<span class="token punctuation">.</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">setOut0</span><span class="token punctuation">(</span><span class="token function">newPrintStream</span><span class="token punctuation">(</span>fdOut<span class="token punctuation">,</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;sun.stdout.encoding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token operator">...</span> <span class="token comment">// 其他代码 </span>
<span class="token punctuation">}</span> 
</code></pre></div><p>setOut0（）是个本地方法，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code>private static native void <span class="token function">setOut0</span><span class="token punctuation">(</span>PrintStream out<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>newPrintStream（）方法的代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code>private static PrintStream <span class="token function">newPrintStream</span><span class="token punctuation">(</span>FileOutputStream fos<span class="token punctuation">,</span> String enc<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enc <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        try <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token builtin">new</span> <span class="token function">PrintStream</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">BufferedOutputStream</span><span class="token punctuation">(</span>fos<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> enc<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>UnsupportedEncodingException uee<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token builtin">new</span> <span class="token function">PrintStream</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">BufferedOutputStream</span><span class="token punctuation">(</span>fos<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>由代码可知，System.out常量是PrintStream类型，它内部包装了一个BufferedOutput -Stream实例。BufferedOutputStream内部又包装了一个FileOutputStream实例。Java的io类库使用了装饰器模式，调用System.out.println（String）方法之后，经过层层包装，最后到达FileOutputStream类的writeBytes（）方法。这个方法无法用Java代码实现，所以是个本地方法，其代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// java.io.FileOutputStream </span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileOutputStream</span> <span class="token keyword">extends</span> <span class="token class-name">OutputStream</span> <span class="token punctuation">{</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 其他代码 </span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">boolean</span> append<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
</code></pre></div><p>System.setOut0（）本地方法在ch11\native\java\lang\System.go文件中实现，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// private static native void setOut0(PrintStream out); </span>
<span class="token keyword">func</span> <span class="token function">setOut0</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    out <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
    sysClass <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    sysClass<span class="token punctuation">.</span><span class="token function">SetRefVar</span><span class="token punctuation">(</span><span class="token string">&quot;out&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Ljava/io/PrintStream;&quot;</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>FileOutputStream.writeBytes（）本地方法在ch11\native\java\io\FileOutput -Stream.go文件中实现，代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// private native void writeBytes(byte b[], int off, int len, boolean append) </span>
<span class="token comment">// throws IOException; </span>
<span class="token keyword">func</span> <span class="token function">writeBytes</span><span class="token punctuation">(</span>frame <span class="token operator">*</span>rtda<span class="token punctuation">.</span>Frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    vars <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token function">LocalVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token comment">//this := vars.GetRef(0) </span>
    b <span class="token operator">:=</span> vars<span class="token punctuation">.</span><span class="token function">GetRef</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
    off <span class="token operator">:=</span> vars<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 
    <span class="token builtin">len</span> <span class="token operator">:=</span> vars<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> 
    <span class="token comment">//append := vars.GetBoolean(4) </span>
    jBytes <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int8</span><span class="token punctuation">)</span> 
    goBytes <span class="token operator">:=</span> <span class="token function">castInt8sToUint8s</span><span class="token punctuation">(</span>jBytes<span class="token punctuation">)</span> 
    goBytes <span class="token operator">=</span> goBytes<span class="token punctuation">[</span>off <span class="token punctuation">:</span> off<span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">]</span> 
    os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>goBytes<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>虽然同是字节类型，但是在Java语言中byte是有符号类型，在Go语言中byte则是无符号类型。所以这里需要先把Java的字节数组转换成Go的[]byte变量，然后再调用os.Std -out.Write（）方法把它写到控制台。castInt8sToUint8s（）函数代码如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">castInt8sToUint8s</span><span class="token punctuation">(</span>jBytes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int8</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>goBytes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    ptr <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jBytes<span class="token punctuation">)</span> 
    goBytes <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>如果读者属于完美主义者，很容易会发现这里的小瑕疵：FileOutputStream应该可以处理任何文件而不仅仅是标准输出。没错，不过本章就到此为止了，感兴趣的读者可以继续完善代码，让FileOutputStream可以支持任何文件。下面测试本章代码。</p> <h4 id="_11-4-测试本章代码"><a href="#_11-4-测试本章代码" class="header-anchor">#</a> 11.4 测试本章代码</h4> <p>打开命令行窗口，执行下面的命令编译本章代码：</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>go <span class="token function">install</span> jvmgo<span class="token punctuation">\</span>ch11 
</code></pre></div><p>命令执行完毕后，在D：\go\workspace\bin目录下出现ch11.exe文件。用ch11.exe测试HelloWorld程序，结果如图11-1所示。
<img src="/jvmgo-doc/assets/img/11-1.68256f09.png" alt="11-1">
图11-1 HelloWorld程序执行结果</p> <h4 id="_11-5-总结"><a href="#_11-5-总结" class="header-anchor">#</a> 11.5 总结</h4> <p>本书共11章，各章内容如下：
第1章讨论了Java虚拟机是如何启动的，介绍了java命令的用法，并且实现了一个类似的命令行工具。</p> <p>第2、第3、第6、第8章讨论了类加载器。其中第2章讨论了Java虚拟机如何搜索class文件，并且实现了类路径，可以把class文件读到内存中。第3章讨论了class文件结构体，并且实现了class文件解析，把难以理解的字节序列转换成了ClassFile结构体。第6章实现了一个简化版的类加载器，进一步处理ClassFile结构体，把它转换成Class结构体放入方法区。第8章对类加载器进行了扩展，使其可以加载数组类。</p> <p>第4、第6章讨论了运行时数据区。其中第4章主要讨论了线程私有的运行时数据区，包括Java虚拟机栈、帧、局部变量表和操作数栈等。第6章主要讨论了线程共享的运行时数据区，包括方法区和运行时常量池等。</p> <p>第7、第9、第10章讨论了方法调用。其中第7章主要讨论了Java方法的调用和返回，并且实现了相关指令。第9章讨论了本地方法调用，并且实现了Java类库中一些最重要的本地方法。第10章讨论了异常处理，并且实现了athrow指令。</p> <p>第5章编写了一个简单的解释器，从这一章开始，我们陆续实现了约200条指令。在Java虚拟机规范已经定义的205条指令中，只剩下8条还没有实现，分别是：控制指令中的jsr和ret；扩展指令中的jsr_w；引用类指令中的invokedynamic、monitorenter和monitorexit；以及保留指令中的breakpoint和impldep2。</p> <p>不过遗憾的是，有很多重要的内容没有讨论：class文件验证、内存管理和垃圾回收、类加载器的委派模型、多线程、JIT，等等。如果本书有机会出第2版，希望可以涵盖这些内容。</p> <div class="language- extra-class"><pre class="language-text"><code></code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/jvmgo-doc/assets/js/app.0e038eb3.js" defer></script><script src="/jvmgo-doc/assets/js/2.9a199717.js" defer></script><script src="/jvmgo-doc/assets/js/15.6c8db65d.js" defer></script>
  </body>
</html>
